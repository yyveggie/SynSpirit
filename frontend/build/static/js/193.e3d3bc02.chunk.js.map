{"version":3,"file":"static/js/193.e3d3bc02.chunk.js","mappings":"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","sources":["components/CommentSection.tsx"],"sourcesContent":["/**\n * CommentSection.tsx\n * \n * 此组件负责渲染和管理特定目标（文章或帖子）的评论区。\n * \n * 主要功能:\n * - 使用 TanStack Query (`useQuery`) 获取并缓存评论列表，管理加载和错误状态。\n * - 根据 Query Key (`['comments', targetType, targetId, sortBy]`) 区分不同排序的缓存。\n * - 使用 `placeholderData` 优化排序切换时的 UI 体验，避免闪烁。\n * - 使用 TanStack Query (`useMutation`) 处理评论的创建、回复、删除和点赞操作，并自动或手动更新缓存。\n * - 显示评论列表 (包括嵌套的回复)，并支持折叠/展开。\n * - 提供顶层评论的输入框。\n * - 支持对现有评论进行回复。\n * - 根据用户登录状态控制评论、回复和删除权限。\n * - 使用虚拟滚动技术（react-window）优化大量评论的渲染性能\n * - 支持懒加载深层嵌套评论，减少初始加载时间和内存占用\n * \n * 注意: 如果新增、删除或修改功能，必须在这开头的注释中同步修改，\n * 如发现功能与注释描述不同，也可以在确定后修改。\n */\nimport React, { useState, useEffect, useCallback, useRef, useMemo, Suspense } from 'react';\nimport axios from 'axios';\nimport { toast } from 'react-toastify';\nimport { Link } from 'react-router-dom';\nimport { formatDistanceToNow } from 'date-fns';\nimport { zhCN } from 'date-fns/locale';\nimport { useAuth } from '../context/AuthContext';\nimport { MessageSquare } from 'lucide-react';\nimport UserAvatar from './UserAvatar';\n// --- TanStack Query Import ---\nimport { useQuery, useQueryClient, useMutation } from '@tanstack/react-query';\n// --- End TanStack Query Import ---\nimport { API_BASE_URL } from '../config';\nimport { FaHeart, FaRegHeart, FaSpinner, FaReply, FaTrashAlt, FaSyncAlt } from 'react-icons/fa';\nimport { BsArrowReturnRight, BsTrash } from 'react-icons/bs';\nimport { motion } from 'framer-motion';\n// --- 新增: 虚拟滚动相关导入 ---\nimport { FixedSizeList as List } from 'react-window';\n// --- 结束新增 ---\n\n// --- 接口定义 ---\ninterface UserInfo {\n  id: number;\n  nickname?: string | null;\n  email?: string;\n  avatar?: string | null; // 确保包含头像\n}\n\ninterface Comment {\n  id: number;\n  content: string;\n  created_at: string;\n  post_id?: number; // 根据 targetType 确定\n  article_id?: number; // 根据 targetType 确定\n  user_id: number | null;\n  parent_id: number | null;\n  user: UserInfo | null;\n  replies: Comment[];\n  likes_count: number;\n  is_liked_by_current_user: boolean;\n  is_deleted?: boolean; // 新增：软删除标记\n  _isOptimistic?: boolean; // 新增：标记乐观更新的临时对象\n  is_ai_generated: boolean;\n}\n\n// 定义乐观更新上下文类型\ninterface ReplyMutationContext {\n  previousComments: Comment[];\n}\n\ninterface CommentSectionProps {\n  targetType: 'post' | 'article'; // 评论目标类型\n  targetId: number;               // 评论目标ID\n  apiBaseUrl: string;             // API基础URL\n  token: string | null;           // 用户认证令牌\n  currentUser: UserInfo | null;   // 当前登录用户信息\n  // --- 新增：点赞、收藏、分享相关 Props ---\n  isLiked: boolean;               // 目标是否已点赞\n  isCollected: boolean;           // 目标是否已收藏\n  likeCount: number;              // 点赞数\n  collectCount: number;           // 收藏数\n  shareCount: number;             // 分享数\n  handleLikeToggle: () => void;   // 处理点赞切换\n  handleCollectToggle: () => void; // 处理收藏切换\n  handleShareClick: () => void;   // 处理分享点击\n  isSubmittingAction: boolean;    // 操作（点赞/收藏/分享）是否正在提交\n  // --- 结束新增 ---\n}\n\n// --- API Fetching Function (移除客户端排序) ---\nconst fetchCommentsAPI = async (targetType: string, targetId: number, sortBy: string, token: string | null) => {\n  // --- 修改：根据 targetType 动态构建 API URL --- \n  let apiUrlBase = '';\n  if (targetType === 'article') {\n    // 文章评论使用新的 /tree 端点获取完整树\n    apiUrlBase = `${API_BASE_URL}/api/original-comments/articles/${targetId}/comments/tree`; \n    // console.log(`[CommentSection DEBUG] Base URL for article comments: ${apiUrlBase}`);\n  } else if (targetType === 'post') {\n    // 帖子评论使用其标准端点获取完整树\n    apiUrlBase = `${API_BASE_URL}/api/posts/${targetId}/comments`; // 这个端点应该返回完整树\n    // console.log(`[CommentSection DEBUG] Base URL for post comments: ${apiUrlBase}`);\n  } else {\n    // console.error(`[CommentSection ERROR] Unknown targetType: ${targetType}`);\n    return []; \n  }\n  // --- 结束修改 ---\n\n  // 将 sortBy 参数添加到 URL\n  const apiUrlWithSort = `${apiUrlBase}?sort_by=${sortBy}`;\n  // console.log(`[CommentSection DEBUG] Fetching comments from: ${apiUrlWithSort}`);\n  \n  // --- 修改：根据 targetType 判断期望的响应结构 ---\n  let fetchedComments: Comment[] = [];\n  if (targetType === 'post') {\n    // 帖子评论 API 可能返回 { comments: [] }\n    const response = await axios.get<{ comments: Comment[] }>(apiUrlWithSort, { \n        headers: token ? { Authorization: `Bearer ${token}` } : {},\n    });\n    fetchedComments = response.data?.comments || [];\n    // console.log(`[CommentSection DEBUG] Post comments raw response data:`, response.data);\n  } else if (targetType === 'article') {\n    // 文章评论 API 直接返回 []\n    const response = await axios.get<Comment[]>(apiUrlWithSort, { \n        headers: token ? { Authorization: `Bearer ${token}` } : {},\n    });\n    fetchedComments = response.data || [];\n  } else {\n    // 未知类型，返回空数组，错误已在上面记录\n    return [];\n  }\n  // --- 结束修改 ---\n  \n  // console.log(`[CommentSection DEBUG] Data received in fetchCommentsAPI before return (targetType: ${targetType}, sortBy: ${sortBy}):`, fetchedComments); \n  return fetchedComments; \n};\n\n// --- Helper function for initializing collapse state ---\nconst initializeCollapseStateRecursively = (\n  comments: Comment[],\n  depth: number,\n  state: { [key: number]: boolean }\n) => {\n  comments.forEach(comment => {\n      if (comment.replies && comment.replies.length > 0) {\n          // 修复：默认展开所有评论，无论深度\n          state[comment.id] = false;  // 默认展开\n          // 递归处理子回复\n          initializeCollapseStateRecursively(comment.replies, depth + 1, state);\n      }\n  });\n};\n\nconst CommentSection: React.FC<CommentSectionProps> = ({\n  targetType,\n  targetId,\n  apiBaseUrl,\n  token,\n  currentUser,\n  // --- 新增：解构新的 Props ---\n  isLiked,\n  isCollected,\n  likeCount,\n  collectCount,\n  shareCount,\n  handleLikeToggle,\n  handleCollectToggle,\n  handleShareClick,\n  isSubmittingAction,\n  // --- 结束新增 ---\n}) => {\n  // --- State Management ---\n  const [newComment, setNewComment] = useState('');\n  const [submittingComment, setSubmittingComment] = useState(false);\n  const [replyToCommentId, setReplyToCommentId] = useState<number | null>(null);\n  const [replyContent, setReplyContent] = useState('');\n  const [submittingReply, setSubmittingReply] = useState(false);\n  const [replyTargetUser, setReplyTargetUser] = useState('');\n  const [sortBy, setSortBy] = useState<'latest' | 'popular'>('latest');\n  // 修改：使用useRef存储展开状态，防止刷新时重置\n  const collapsedCommentsRef = useRef<{ [key: number]: boolean }>({});\n  const [collapsedComments, setCollapsedComments] = useState<{ [key: number]: boolean }>({});\n  const [isCommentFocused, setIsCommentFocused] = useState(false);\n  const { token: authToken, user: currentUserFromAuth } = useAuth();\n  const commentInputRef = useRef<HTMLTextAreaElement>(null);\n  const replyInputRef = useRef<HTMLTextAreaElement>(null);\n  const queryClient = useQueryClient();\n  const [refreshAnimationKey, setRefreshAnimationKey] = useState(0);\n  \n  // --- 新增: 用于虚拟滚动的状态 ---\n  const [itemSize, setItemSize] = useState<number>(150); // 预估的每个评论项的高度\n  const [flattenedComments, setFlattenedComments] = useState<any[]>([]); // 扁平化后的评论列表\n  const [listWidth, setListWidth] = useState<number>(window.innerWidth - 40); // 虚拟列表宽度\n  // 动态计算列表高度\n  const listHeight = useMemo(() => Math.min(600, window.innerHeight * 0.7), []);\n  // --- 结束新增 ---\n  \n  // --- 移到组件内部: 使用useCallback包装初始化函数 ---\n  const initializeCollapseStateRecursively = useCallback((\n    comments: Comment[],\n    depth: number,\n    state: { [key: number]: boolean }\n  ) => {\n    comments.forEach(comment => {\n      if (comment.replies && comment.replies.length > 0) {\n        // 修改：不自动折叠任何评论，保持所有评论默认展开\n        state[comment.id] = false;\n        initializeCollapseStateRecursively(comment.replies, depth + 1, state);\n      }\n    });\n  }, []);\n  \n  // --- TanStack Query for fetching comments ---\n  const commentsQueryKey = ['comments', targetType, targetId, sortBy, currentUser?.id || 'anonymous'];\n\n  const { \n    data: comments = [],\n    isLoading: loadingComments,\n    isError: isCommentError,\n    error: commentError,\n    refetch: refetchComments\n  } = useQuery<Comment[], Error>({\n    queryKey: commentsQueryKey,\n    queryFn: () => fetchCommentsAPI(targetType, targetId, sortBy, authToken),\n    staleTime: 5 * 60 * 1000,\n    gcTime: 10 * 60 * 1000,\n    placeholderData: (previousData) => previousData ?? [],\n    enabled: !!targetId && !!targetType,\n  });\n\n  // --- 修改日志：包含 isLoading 和 isError ---\n  useEffect(() => {\n    console.log(\n        // `[CommentSection DEBUG] State from useQuery (targetType: ${targetType}, targetId: ${targetId}, sortBy: ${sortBy}):`, \n        { isLoading: loadingComments, isError: isCommentError, commentsData: comments } // 同时打印状态和数据\n    );\n    if (isCommentError) {\n        // console.error(\"[CommentSection DEBUG] useQuery reported an error:\", commentError); // 如果出错，打印错误对象\n    }\n  }, [comments, loadingComments, isCommentError, commentError, targetType, targetId, sortBy]); \n  // --- 结束修改 ---\n\n  // --- 修改：点赞、回复等操作后保留评论的展开状态 ---\n  useEffect(() => {\n    if (comments && comments.length > 0) {\n      // 创建新状态对象，但保留已有的展开/折叠状态\n      const updatedState = { ...collapsedCommentsRef.current };\n      \n      // 仅为新的评论ID初始化状态\n      comments.forEach(comment => {\n        if (comment.replies && comment.replies.length > 0) {\n          // 如果评论ID不在当前状态中，则初始化为展开状态\n          if (updatedState[comment.id] === undefined) {\n            updatedState[comment.id] = false; // 默认展开\n          }\n          \n          // 递归处理回复\n          const processReplies = (replies: Comment[]) => {\n            replies.forEach(reply => {\n              if (reply.replies && reply.replies.length > 0) {\n                if (updatedState[reply.id] === undefined) {\n                  updatedState[reply.id] = false; // 默认展开\n                }\n                processReplies(reply.replies);\n              }\n            });\n          };\n          \n          processReplies(comment.replies);\n        }\n      });\n      \n      // 更新状态引用和React状态\n      collapsedCommentsRef.current = updatedState;\n      setCollapsedComments(updatedState);\n    }\n  }, [comments]);\n\n  // --- Helper Functions (Unchanged unless they used old state) ---\n  const countTotalComments = useCallback((commentList: Comment[]): number => {\n    let count = 0;\n    for (const comment of commentList) {\n      count++;\n      if (comment.replies && comment.replies.length > 0) {\n        count += countTotalComments(comment.replies);\n      }\n    }\n    return count;\n  }, []);\n\n  // --- Mutations (Example: Submit Comment) ---\n  const submitCommentMutation = useMutation<\n    Comment,\n    Error,\n    { content: string; mentionLynn?: boolean }\n  >({\n    mutationFn: async ({ content, mentionLynn }) => {\n      // --- 修改：确保使用 original-comments 路径创建文章评论 ---\n      let postUrl = '';\n      if (targetType === 'article') {\n        postUrl = `${API_BASE_URL}/api/original-comments/articles/${targetId}/comments`;\n      } else if (targetType === 'post') {\n        postUrl = `${API_BASE_URL}/api/posts/${targetId}/comments`; // 假设帖子评论创建路径不同\n      } else {\n        throw new Error(`[Submit Comment] Unknown targetType: ${targetType}`);\n      }\n\n      // 构建请求体\n      const requestBody: { content: string; mention_lynn?: boolean } = {\n        content: content.trim(),\n      };\n\n      if (mentionLynn) {\n        requestBody.mention_lynn = true;\n      }\n\n      const response = await axios.post<Comment>(\n        postUrl,\n        requestBody,\n        { headers: { Authorization: `Bearer ${authToken}` } }\n      );\n      return response.data;\n    },\n    onSuccess: (newCommentData) => {\n      queryClient.invalidateQueries({ queryKey: ['comments', targetType, targetId] });\n      setNewComment('');\n      toast.success('评论发表成功！');\n    },\n    onError: (err) => {\n      console.error(\"提交评论失败:\", err);\n      const errorMsg = err.message || '评论提交失败';\n      toast.error(errorMsg);\n    },\n    onSettled: () => {\n      setSubmittingComment(false);\n    }\n  });\n\n  const handleSubmitComment = () => {\n    if (!authToken || !newComment.trim()) {\n      toast.warn(\"评论内容不能为空且需要登录。\");\n      return;\n    }\n    setSubmittingComment(true);\n\n    // 新增：检测 @lynn 提及\n    const mentionLynn = newComment.toLowerCase().includes('@lynn');\n\n    submitCommentMutation.mutate({ content: newComment, mentionLynn });\n  };\n  \n  // --- Submit Reply Mutation (Similar structure) ---\n  const submitReplyMutation = useMutation<\n    Comment,\n    Error,\n    { parentId: number, content: string, mentionLynn?: boolean },\n    ReplyMutationContext\n  >({\n    mutationFn: async ({ parentId, content, mentionLynn }) => {\n      // --- 修改：确保使用 original-comments 路径创建文章回复 ---\n      let replyUrl = '';\n      if (targetType === 'article') {\n        replyUrl = `${API_BASE_URL}/api/original-comments/articles/${targetId}/comments/${parentId}/replies`;\n      } else if (targetType === 'post') {\n        replyUrl = `${API_BASE_URL}/api/posts/${targetId}/comments/${parentId}/replies`; // 假设帖子回复路径不同\n      } else {\n        throw new Error(`[Submit Reply] Unknown targetType: ${targetType}`);\n      }\n      \n      // 增加日志记录请求URL和参数\n      // console.log(`[CommentSection DEBUG] 提交回复请求: ${replyUrl}`, {\n      //   parentId, \n      //   content,\n      //   targetType,\n      //   targetId\n      // });\n      \n      // 构建请求体\n      const requestBody: { content: string; mention_lynn?: boolean } = {\n        content: content.trim(),\n      };\n\n      if (mentionLynn) {\n        requestBody.mention_lynn = true;\n      }\n      \n      const response = await axios.post<Comment>(\n        replyUrl,\n        requestBody,\n        { headers: { Authorization: `Bearer ${authToken}` } }\n      );\n      \n      // 增加日志记录响应结果\n      // console.log(`[CommentSection DEBUG] 提交回复响应:`, response.data);\n      \n      return response.data;\n    },\n    // --- 新增：添加乐观更新逻辑 ---\n    onMutate: async ({ parentId, content }) => {\n      // 取消正在进行的查询以避免它们覆盖我们的乐观更新\n      await queryClient.cancelQueries({ queryKey: commentsQueryKey });\n      \n      // 保存当前状态，以便在出错时恢复\n      const previousComments = queryClient.getQueryData<Comment[]>(commentsQueryKey) || [];\n      \n      // 创建一个临时的乐观回复对象\n      const optimisticReply: Comment = {\n        id: Date.now(), // 临时ID，最终会被后端返回的实际ID替换\n        content: content,\n        created_at: new Date().toISOString(),\n        user_id: currentUser?.id || null,\n        parent_id: parentId,\n        user: currentUser, // 当前用户信息\n        replies: [],\n        likes_count: 0,\n        is_liked_by_current_user: false,\n        _isOptimistic: true, // 标记为乐观更新的临时对象\n        is_ai_generated: false,\n      };\n      \n      // 更新缓存数据，添加新回复到父评论\n      queryClient.setQueryData<Comment[]>(commentsQueryKey, (oldComments = []) => {\n        // 深拷贝旧评论列表\n        const newComments = JSON.parse(JSON.stringify(oldComments));\n        \n        // 定义一个递归函数来找到父评论并添加回复\n        const addReplyToParent = (comments: Comment[]): Comment[] => {\n          return comments.map(comment => {\n            if (comment.id === parentId) {\n              // 找到父评论，添加回复\n              return {\n                ...comment,\n                replies: [...(comment.replies || []), optimisticReply]\n              };\n            }\n            \n            // 如果有嵌套回复，也在其中查找\n            if (comment.replies && comment.replies.length > 0) {\n              return {\n                ...comment,\n                replies: addReplyToParent(comment.replies)\n              };\n            }\n            \n            return comment;\n          });\n        };\n        \n        return addReplyToParent(newComments);\n      });\n      \n      // console.log(\"[CommentSection] 已添加乐观回复\");\n      \n      // 返回上下文对象，用于出错时恢复\n      return { previousComments };\n    },\n    // --- 结束新增 ---\n    onSuccess: (newReplyData, variables) => {\n      // --- 修改：更精确的缓存更新 ---\n      // console.log(\"[CommentSection] 回复成功，更新缓存:\", newReplyData);\n      \n      // 更新缓存，替换乐观回复为实际回复\n      queryClient.setQueryData<Comment[]>(commentsQueryKey, (oldComments = []) => {\n        if (!oldComments.length) {\n          // 如果没有缓存的评论，重新获取\n          queryClient.invalidateQueries({ queryKey: commentsQueryKey });\n          return oldComments;\n        }\n        \n        // 深拷贝旧评论列表\n        const newComments = JSON.parse(JSON.stringify(oldComments));\n        \n        // 更新临时回复为实际回复\n        const updateOptimisticReply = (comments: Comment[]): Comment[] => {\n          return comments.map(comment => {\n            if (comment.id === variables.parentId) {\n              return {\n                ...comment,\n                replies: comment.replies.map(reply => \n                  // 如果是之前创建的乐观回复，替换为真实数据\n                  (reply._isOptimistic) ? newReplyData : reply\n                )\n              };\n            }\n            \n            if (comment.replies && comment.replies.length > 0) {\n              return {\n                ...comment,\n                replies: updateOptimisticReply(comment.replies)\n              };\n            }\n            \n            return comment;\n          });\n        };\n        \n        return updateOptimisticReply(newComments);\n      });\n      // --- 结束修改 ---\n      \n      setReplyContent('');\n      setReplyToCommentId(null);\n      toast.success('回复成功！');\n    },\n    onError: (err, variables, context) => {\n      console.error(\"提交回复失败:\", err);\n      toast.error(err.message || '回复提交失败');\n      \n      // --- 新增：错误恢复 ---\n      // 恢复到之前的状态\n      if (context?.previousComments) {\n        queryClient.setQueryData(commentsQueryKey, context.previousComments);\n      }\n      // --- 结束新增 ---\n    },\n    onSettled: () => {\n      setSubmittingReply(false);\n    }\n  });\n\n  const handleSubmitReply = (parentId: number) => {\n    if (!authToken || !replyContent.trim()) {\n      toast.warn(\"回复内容不能为空且需要登录。\");\n      return;\n    }\n    setSubmittingReply(true);\n\n    // 新增：检测 @lynn 提及\n    const mentionLynnForReply = replyContent.toLowerCase().includes('@lynn');\n\n    submitReplyMutation.mutate({ parentId, content: replyContent, mentionLynn: mentionLynnForReply });\n  };\n\n  // --- Delete Comment Mutation ---\n  const deleteCommentMutation = useMutation<\n    void,\n    Error,\n    { commentId: number }\n  >({\n    mutationFn: async ({ commentId }) => {\n      // --- 修改：确保使用 original-comments 路径删除文章评论 ---\n      let deleteUrl = '';\n      if (targetType === 'article') {\n        // 根据 original_comments.py 中的路由定义，删除需要 article_id\n        deleteUrl = `${API_BASE_URL}/api/original-comments/articles/${targetId}/comments/${commentId}`;\n      } else if (targetType === 'post') {\n        deleteUrl = `${API_BASE_URL}/api/posts/${targetId}/comments/${commentId}`; // 假设帖子删除路径不同\n      } else {\n         throw new Error(`[Delete Comment] Unknown targetType: ${targetType}`);\n      }\n      await axios.delete(deleteUrl, { headers: { Authorization: `Bearer ${authToken}` } });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['comments', targetType, targetId] });\n      toast.success('评论已删除');\n    },\n    onError: (err) => {\n      console.error(\"删除评论失败:\", err);\n      toast.error(err.message || '删除评论失败');\n    },\n  });\n\n  const handleDeleteCommentOrReply = (commentId: number) => {\n    if (!authToken) {\n      toast.error(\"请先登录。\");\n      return;\n    }\n    if (!window.confirm('确定要删除这条评论吗？其下的回复将保留，但此评论内容会消失。')) {\n      return;\n    }\n    deleteCommentMutation.mutate({ commentId });\n  };\n\n  // --- Like/Unlike Mutations (Can be combined or separate) ---\n  const toggleLikeMutation = useMutation<\n    { likes_count: number; is_liked_by_current_user: boolean },\n    Error,\n    { commentId: number; isLiked: boolean }\n  >({\n    mutationFn: async ({ commentId, isLiked }) => {\n      let url;\n      // 根据评论目标类型 (targetType prop) 构造不同的点赞 URL\n      if (targetType === 'post') {\n        // 帖子评论使用 /api/posts/post_comments/.../like\n        url = `${API_BASE_URL}/api/posts/post_comments/${commentId}/like`;\n      } else if (targetType === 'article') {\n        // 文章评论使用 /api/original-comments/comments/.../like\n        // original_comments.py 中的相应路由默认 target_type 为 'article'\n        url = `${API_BASE_URL}/api/original-comments/comments/${commentId}/like`;\n      } else {\n        console.error(`[CommentSection ERROR] Unsupported targetType for like: ${targetType}`);\n        // 保留一个回退，尽管理想情况下应该为所有支持的类型明确处理或报错\n        url = `${API_BASE_URL}/api/comments/${commentId}/like?target_type=${targetType}`;\n      }\n      \n      // console.log(`[CommentSection DEBUG] Toggle like URL: ${url}`);\n\n      let response;\n      if (isLiked) {\n        response = await axios.delete(url, { headers: { Authorization: `Bearer ${authToken}` } });\n      } else {\n        response = await axios.post(url, {}, { headers: { Authorization: `Bearer ${authToken}` } });\n      }\n      // --- 状态码检查保持不变 ---\n      if (!(response.status === 200 || response.status === 201 || response.status === 204)) {\n         throw new Error(response.data?.message || 'Like/Unlike API Error');\n      }\n      \n      // 处理响应数据中的字段名可能不一致的问题\n      const responseData = response.data || {};\n      // 修改：优先读取 likes_count，兼容旧的 like_count\n      const result = {\n        likes_count: responseData.likes_count !== undefined ? responseData.likes_count : (responseData.like_count || 0),\n        is_liked_by_current_user: responseData.is_liked_by_current_user !== undefined \n          ? responseData.is_liked_by_current_user \n          : responseData.is_liked \n      };\n      \n      return result;\n    },\n    onSuccess: (data, variables) => {\n      queryClient.setQueryData(commentsQueryKey, (oldData: Comment[] | undefined = []) => {\n        const updateRecursively = (list: Comment[]): Comment[] => list.map(c => {\n          if (c.id === variables.commentId) {\n            return { \n              ...c, \n              // 修改：更新缓存中的 likes_count\n              likes_count: data.likes_count, \n              is_liked_by_current_user: data.is_liked_by_current_user \n            };\n          }\n          if (c.replies && c.replies.length > 0) {\n            return { ...c, replies: updateRecursively(c.replies) };\n          }\n          return c;\n        });\n        return updateRecursively(oldData);\n      });\n    },\n    onError: (err, variables) => {\n      console.error(\"Like/Unlike失败:\", err);\n      toast.error(`操作失败: ${err.message}`);\n    }\n  });\n\n  const handleLike = (commentId: number) => {\n    if (!authToken) { toast.warn(\"请先登录\"); return; }\n    toggleLikeMutation.mutate({ commentId, isLiked: false });\n  };\n\n  const handleUnlike = (commentId: number) => {\n    if (!authToken) { toast.warn(\"请先登录\"); return; }\n    toggleLikeMutation.mutate({ commentId, isLiked: true });\n  };\n\n  // --- Other functions (handleReplyClick, handleCancelReply, toggleReplies, handleSortChange, etc.) remain largely the same ---\n  const handleReplyClick = (commentId: number, targetUsername: string) => {\n    if (replyToCommentId === commentId) {\n      setReplyToCommentId(null);\n      setReplyTargetUser('');\n      setReplyContent('');\n    } else {\n      if (replyToCommentId !== null) {\n        setReplyToCommentId(null);\n        setReplyTargetUser('');\n        setReplyContent('');\n        setTimeout(() => {\n      setReplyToCommentId(commentId);\n      setReplyTargetUser(targetUsername);\n      setReplyContent('');\n          setTimeout(() => { replyInputRef.current?.focus(); }, 10);\n        }, 10);\n      } else {\n        setReplyToCommentId(commentId);\n        setReplyTargetUser(targetUsername);\n        setReplyContent('');\n        setTimeout(() => { replyInputRef.current?.focus(); }, 10);\n      }\n    }\n  };\n  \n  const handleCancelReply = () => {\n    setReplyToCommentId(null);\n    setReplyTargetUser('');\n    setReplyContent('');\n  };\n  \n  // --- 修改：切换评论折叠状态的函数，确保也更新ref ---\n  const toggleReplies = (commentId: number, e?: React.MouseEvent) => {\n    e?.stopPropagation();\n    \n    const newState = {\n      ...collapsedComments,\n      [commentId]: !collapsedComments[commentId]\n    };\n    \n    // 同时更新引用和状态\n    collapsedCommentsRef.current = newState;\n    setCollapsedComments(newState);\n  };\n\n  const handleSortChange = (e: React.MouseEvent, newSortBy: 'latest' | 'popular') => {\n    e.preventDefault();\n    e.stopPropagation();\n    \n    if (sortBy !== newSortBy) {\n      const scrollPos = commentsContainerRef.current?.scrollTop || 0;\n      \n      setSortBy(prevSortBy => {\n        console.log(`切换排序：${prevSortBy} -> ${newSortBy}`);\n        return newSortBy;\n      });\n      \n      // 手动触发数据重新获取\n      refetchComments();\n\n      requestAnimationFrame(() => {\n        if (commentsContainerRef.current) {\n          commentsContainerRef.current.scrollTop = scrollPos;\n        }\n      });\n    }\n  };\n\n  const handleCommentChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    setNewComment(e.target.value);\n  };\n\n  const handleReplyChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    setReplyContent(e.target.value);\n  };\n\n  const handleCommentFocus = () => setIsCommentFocused(true);\n  const handleCommentBlur = () => {\n    if (!newComment.trim()) {\n      setIsCommentFocused(false);\n        }\n  };\n\n  // Restore commentsContainerRef definition\n  const commentsContainerRef = useRef<HTMLDivElement>(null);\n\n  // --- 新增：刷新按钮点击处理函数 ---\n  const handleRefreshComments = useCallback(() => {\n    if (!loadingComments) { // Only trigger animation if not already loading\n        setRefreshAnimationKey(prevKey => prevKey + 1);\n    }\n    if (refetchComments) { // Check if refetchComments is defined\n        refetchComments();\n        toast.info(\"正在刷新评论...\");\n    } else {\n        console.error(\"refetchComments function is not available.\");\n        toast.error(\"刷新功能暂时无法使用。\");\n    }\n  }, [loadingComments, refetchComments]);\n  // --- 结束新增 ---\n\n  // --- 新增: useEffect 将评论树转换为扁平列表 ---\n  useEffect(() => {\n    if (comments && comments.length > 0) {\n      const flattened: any[] = [];\n      \n      /**\n       * 扁平化评论树结构，用于虚拟滚动\n       * @param commentList 评论列表\n       * @param depth 当前深度\n       * @param isVisible 是否可见（父评论是否折叠）\n       */\n      const flattenComments = (commentList: Comment[], depth: number = 0, isVisible: boolean = true) => {\n        for (const comment of commentList) {\n          // 修复：当父评论被折叠时，子评论不可见\n          // 注意：只有当父评论在collapsedComments中值为true时才是折叠状态\n          const currentVisible = isVisible && !(comment.parent_id !== null && comment.parent_id in collapsedComments && collapsedComments[comment.parent_id]);\n          \n          // 添加到扁平列表\n          flattened.push({\n            ...comment,\n            depth,\n            visible: currentVisible\n          });\n          \n          // 递归处理回复，但如果当前评论被折叠则跳过\n          if (comment.replies && comment.replies.length > 0 && !collapsedComments[comment.id]) {\n            flattenComments(comment.replies, depth + 1, currentVisible);\n          }\n        }\n      };\n      \n      flattenComments(comments);\n      setFlattenedComments(flattened);\n    } else {\n      setFlattenedComments([]);\n    }\n  }, [comments, collapsedComments]);\n  // --- 结束新增 ---\n  \n  /**\n   * 递归查找特定ID的评论\n   * @param commentList 评论列表\n   * @param id 要查找的评论ID\n   * @returns 找到的评论或undefined\n   */\n  const findCommentById = useCallback((commentList: Comment[], id: number): Comment | undefined => {\n    for (const comment of commentList) {\n      if (comment.id === id) {\n        return comment;\n      }\n      \n      if (comment.replies && comment.replies.length > 0) {\n        const found = findCommentById(comment.replies, id);\n        if (found) return found;\n      }\n    }\n    \n    return undefined;\n  }, []);\n  // --- 结束新增 ---\n\n  // --- 修改: 渲染单个评论的函数，用于虚拟列表项 ---\n  const CommentItem = useCallback(({ index, style }: { index: number, style: React.CSSProperties }) => {\n    // 如果索引无效（-1或超出范围）或评论不可见，返回空元素\n    if (index < 0 || index >= flattenedComments.length || !flattenedComments[index].visible) {\n      return null;\n    }\n    \n    const comment = flattenedComments[index];\n    const depth = comment.depth || 0;\n    \n    // 重用现有的renderComment逻辑\n    return (\n      <div \n        key={comment.id} \n        className={`comment-item py-3 relative depth-${depth > 0 ? Math.min(depth, 5) : 0}`} \n              style={{ \n          paddingLeft: depth > 0 ? `${depth * 8}px` : '0',\n          marginLeft: depth > 0 ? '12px' : '0',\n          borderLeft: depth > 0 ? `1px solid rgba(0, 0, 0, 0.3)` : 'none',\n          paddingTop: depth > 0 ? '12px' : '8px'\n        }}\n      >\n        {/* 添加Reddit风格的回复线 */}\n        {depth > 0 && (\n          <div className=\"absolute\" style={{\n            left: \"-1px\",\n            top: \"28px\",\n            width: \"12px\", \n            height: \"16px\",\n            borderBottomLeftRadius: \"8px\",\n            borderLeft: `1px solid rgba(0, 0, 0, 0.3)`,\n            borderBottom: `1px solid rgba(0, 0, 0, 0.3)`,\n              }}></div>\n         )}\n        \n         <div className=\"flex items-start mb-1 user-info\">\n          <div className=\"flex-shrink-0\" style={{minWidth: '24px'}}>\n            <UserAvatar userId={comment.user?.id ?? undefined} \n                       username={comment.user?.nickname || comment.user?.email?.split('@')[0] || '匿名用户'} \n                       avatar={comment.user?.avatar} \n                       size=\"sm\" \n                       showName={false}\n                         className=\"\"\n            />\n          </div>\n          <div className=\"flex-grow ml-3\">\n              <div className=\"flex items-baseline justify-between\">\n              <span className={`font-medium text-sm ${comment.is_ai_generated ? 'text-purple-600 dark:text-purple-400' : 'text-blue-600 dark:text-blue-400'}`}>\n                {comment.user?.nickname || comment.user?.email?.split('@')[0] || '匿名用户'}\n                </span>\n                <span className=\"text-xs text-gray-500 pt-1 ml-auto\">\n                  {formatDistanceToNow(new Date(comment.created_at), { addSuffix: true, locale: zhCN })}\n                </span>\n              </div>\n              \n              <p style={{color: 'black'}} className=\"text-sm mt-1 whitespace-pre-wrap break-words\">\n                {comment.is_ai_generated ? (\n                  <span className=\"text-purple-600 dark:text-purple-400\">{comment.content}</span>\n              ) : comment.is_deleted === true ? (\n                  <span className=\"text-blue-400 italic\">{comment.content}</span>\n                ) : (\n                  <span style={{color: 'black'}}>{comment.content}</span>\n                )}\n              </p>\n            \n              <div className=\"mt-2 flex items-center\">\n              {!comment.is_deleted && (\n                  <div className=\"flex items-center\">\n                    {/* 折叠按钮移到最左侧 */}\n                  {comment.replies && comment.replies.length > 0 && (\n                      <button\n                        onClick={(e) => toggleReplies(comment.id, e)}\n                      className=\"text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 py-0 px-0.5 focus:outline-none font-mono text-xs flex items-center justify-center mr-3 w-[36px] text-center\"\n                      aria-label={collapsedComments[comment.id] ? '展开回复' : '收起回复'}>\n                      {collapsedComments[comment.id] ? `[+${countTotalComments(comment.replies)}]` : '[-]'}\n                      </button>\n                    )}\n                    \n                    {/* 回复按钮 */}\n                  <button onClick={() => handleReplyClick(comment.id, comment.user?.nickname || comment.user?.email?.split('@')[0] || '匿名用户')}\n                    className={`text-xs ${replyToCommentId === comment.id ? 'text-blue-600' : 'text-gray-500 hover:text-blue-600'} flex items-center mr-4`}\n                    disabled={!authToken} title={!authToken ? \"请先登录\" : (replyToCommentId === comment.id ? \"取消回复\" : \"回复\")}>\n                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-3.5 w-3.5\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n                        <path fillRule=\"evenodd\" d=\"M7.707 3.293a1 1 0 010 1.414L5.414 7H11a7 7 0 017 7v2a1 1 0 11-2 0v-2a5 5 0 00-5-5H5.414l2.293 2.293a1 1 0 11-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                      </svg>\n                    </button>\n                    \n                    {/* 点赞按钮 */}\n                  <button onClick={() => authToken ? (comment.is_liked_by_current_user ? handleUnlike(comment.id) : handleLike(comment.id)) : toast.warn('请先登录后点赞')}\n                    className={`text-xs flex items-center transition-colors duration-200 ${comment.is_liked_by_current_user ? 'text-pink-500 hover:text-pink-400' : 'text-gray-500 hover:text-pink-400'} mr-4`}\n                    disabled={!authToken || toggleLikeMutation.isPending} title={!authToken ? \"请先登录\" : (comment.is_liked_by_current_user ? \"取消点赞\" : \"点赞\")}>\n                    {comment.is_liked_by_current_user ? (\n                        <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-3.5 w-3.5\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n                          <path fillRule=\"evenodd\" d=\"M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z\" clipRule=\"evenodd\" />\n                        </svg>\n                      ) : (\n                        <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-3.5 w-3.5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" strokeWidth=\"2\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z\" />\n                        </svg>\n                      )}\n                    {comment.likes_count > 0 && <span className=\"text-xs ml-1\">{comment.likes_count}</span>}\n                    </button>\n                    \n                    {/* 删除按钮 */}\n                  {currentUser && comment.user && currentUser.id === comment.user.id && !comment.is_deleted && !comment.is_ai_generated && (\n                      <button onClick={() => handleDeleteCommentOrReply(comment.id)}\n                        className=\"text-xs text-gray-500 hover:text-red-500 flex items-center\" title=\"删除评论\">\n                        <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-3.5 w-3.5\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n                          <path fillRule=\"evenodd\" d=\"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z\" clipRule=\"evenodd\" />\n                        </svg>\n                      </button>\n                    )}\n                  </div>\n                )}\n              </div>\n              \n              {/* 回复输入框 */}\n              {replyToCommentId === comment.id && (\n                <div className=\"relative w-full mt-3\">\n                  <textarea ref={replyInputRef} value={replyContent} onChange={handleReplyChange}\n                    placeholder={`回复 ${replyTargetUser}...`} rows={2}\n                    className=\"w-full p-3 pr-10 pb-3 bg-gray-800/90 rounded-md text-sm text-white placeholder-gray-400 resize-none h-16 shadow-inner border-0 outline-none focus:ring-1 focus:ring-blue-500/50\"\n                    autoFocus />\n                  <div className=\"absolute bottom-2 right-2 flex items-center space-x-2\">\n                    <button onClick={() => handleSubmitReply(comment.id)}\n                      disabled={submittingReply || !replyContent.trim()} title=\"回复\"\n                      className={`text-white hover:text-blue-300 disabled:text-gray-500 disabled:cursor-not-allowed transition-colors duration-200 p-1 rounded hover:bg-gray-700/50 ${submittingReply ? 'animate-pulse' : ''}`}>\n                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5 transform rotate-180\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" strokeWidth=\"2\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M3 10h10a8 8 0 018 8v2M3 10l4-4m-4 4l4 4\" />\n                      </svg>\n                    </button>\n                  </div>\n                </div>\n              )}\n            </div>\n         </div>\n         \n        {/* 回复容器 - 移除ml-6减少DOM嵌套的影响 */}\n        {comment.replies && comment.replies.length > 0 && (\n          <div className=\"replies-container relative mt-2 space-y-2 overflow-hidden transition-all duration-300 ease-in-out\" \n              style={{ \n                // 修复：当collapsedComments为true时应该折叠\n                maxHeight: collapsedComments[comment.id] ? '0' : '10000px',\n                opacity: collapsedComments[comment.id] ? 0 : 1,\n                marginTop: collapsedComments[comment.id] ? '0' : '0.5rem',\n                transform: collapsedComments[comment.id] ? 'translateY(-10px)' : 'translateY(0)',\n              }}>\n            {/* 修复：仅当未折叠时显示回复 */}\n            {!collapsedComments[comment.id] && (\n              <>\n                {comment.replies.map((reply: Comment) => {\n                  const replyIndex = flattenedComments.findIndex(item => item.id === reply.id);\n                  return replyIndex >= 0 ? CommentItem({ index: replyIndex, style: {} }) : null;\n                })}\n              </>\n            )}\n          </div>\n        )}\n      </div>\n    );\n  }, [flattenedComments, collapsedComments, countTotalComments, handleReplyClick, handleSubmitReply, toggleReplies, authToken, currentUser, replyContent, replyInputRef, replyTargetUser, replyToCommentId, submittingReply, toggleLikeMutation.isPending, handleDeleteCommentOrReply, handleLike, handleUnlike]);\n  \n  // --- 新增: 响应窗口大小变化 ---\n  useEffect(() => {\n    const handleResize = () => {\n      // 更新虚拟列表宽度\n      setListWidth(window.innerWidth - 40); // 减去一些边距\n    };\n    \n    // 添加resize事件监听\n    window.addEventListener('resize', handleResize);\n    \n    // 组件卸载时移除事件监听\n    return () => {\n      window.removeEventListener('resize', handleResize);\n    };\n  }, []);\n  // --- 结束新增 ---\n\n  // --- 主渲染 - 更新主渲染函数 ---\n  return (\n    <div className=\"mt-10 pt-6 border-t border-gray-300/50\" ref={commentsContainerRef}>\n       {/* --- 修改：评论区头部，包含评论总数、排序和操作按钮 --- */}\n      <div className=\"flex justify-between items-center mb-6\">\n         {/* --- 修改：将评论图标和计数添加到按钮组 --- */}\n         <div className=\"flex items-center space-x-3\">\n            {/* 评论图标和计数 */}\n            <div className=\"flex items-center text-gray-600 text-sm\">\n                {/* @ts-ignore */}\n                <MessageSquare size={16} className=\"mr-1\" />\n                <span className=\"tabular-nums\">({countTotalComments(comments)})</span>\n            </div>\n            {/* 点赞按钮 */}\n            <button\n              onClick={handleLikeToggle}\n              className={`p-1.5 rounded-md text-sm font-medium flex items-center gap-1 transition-colors duration-300 \n                ${isLiked ? 'text-pink-400 hover:text-pink-300 active:text-pink-500' : 'text-gray-400 hover:text-gray-200 active:text-gray-300'} \n                ${!token && 'opacity-50 cursor-not-allowed'}`}\n              disabled={!token}\n              title={!token ? \"请先登录\" : (isLiked ? '取消点赞' : '点赞')}\n            >\n              <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-4 w-4\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n                <path fillRule=\"evenodd\" d=\"M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z\" clipRule=\"evenodd\" />\n              </svg>\n              <span className=\"tabular-nums\">({likeCount})</span>\n            </button>\n            {/* 收藏按钮 */}\n            <button\n              onClick={handleCollectToggle}\n              className={`p-1.5 rounded-md text-sm font-medium flex items-center gap-1 transition-colors duration-300 \n                ${isCollected ? 'text-yellow-400 hover:text-yellow-300 active:text-yellow-500' : 'text-gray-400 hover:text-gray-200 active:text-gray-300'} \n                ${!token && 'opacity-50 cursor-not-allowed'}`}\n              disabled={!token}\n              title={!token ? \"请先登录\" : (isCollected ? '取消收藏' : '收藏')}\n            >\n              <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-4 w-4\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n                <path d=\"M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-3.5L5 18V4z\" />\n              </svg>\n              <span className=\"tabular-nums\">({collectCount})</span>\n            </button>\n            {/* 分享按钮 */}\n          <button \n              onClick={handleShareClick}\n              className={`p-1.5 rounded-md text-sm font-medium flex items-center gap-1 transition-colors duration-300 \n                text-gray-400 hover:text-gray-200 active:text-gray-300 \n                ${!token && 'opacity-50 cursor-not-allowed'}`}\n              disabled={!token}\n              title={!token ? \"请先登录\" : \"分享\"}\n            >\n              <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-4 w-4\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" strokeWidth={2}>\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z\" />\n            </svg>\n              {shareCount > 0 && <span className=\"tabular-nums\">({shareCount})</span>}\n          </button>\n         </div>\n         {/* --- 结束新增操作按钮 --- */}\n\n         {/* --- 修改：将排序按钮移回左侧 --- */}\n         <div className=\"flex items-center space-x-2\">\n                <button\n              onClick={(e) => handleSortChange(e, 'latest')}\n              className={`px-4 py-1.5 rounded-full transition-colors text-xs font-medium ${ \n                sortBy === 'latest' \n                  ? 'bg-gray-200/80 dark:bg-gray-700/80 text-gray-900 dark:text-gray-100'\n                  : 'bg-transparent text-gray-500 hover:bg-gray-100/50 dark:hover:bg-gray-800/50 hover:text-gray-900 dark:hover:text-gray-100'\n              }`}\n                >\n                  最新\n                </button>\n                <button\n              onClick={(e) => handleSortChange(e, 'popular')}\n              className={`px-4 py-1.5 rounded-full transition-colors text-xs font-medium ${ \n                sortBy === 'popular' \n                  ? 'bg-gray-200/80 dark:bg-gray-700/80 text-gray-900 dark:text-gray-100'\n                  : 'bg-transparent text-gray-500 hover:bg-gray-100/50 dark:hover:bg-gray-800/50 hover:text-gray-900 dark:hover:text-gray-100'\n              }`}\n                >\n                  热门\n                </button>\n              </div>\n         {/* --- 结束排序按钮修改 --- */}\n      </div>\n      {/* --- 结束修改 --- */}\n\n      {/* 评论输入框 */}\n      {token && currentUser && (\n        <div className=\"mb-8 flex items-center space-x-2\">\n          <div className=\"relative flex-grow\">\n            <textarea \n              ref={commentInputRef}\n              value={newComment} \n              onChange={handleCommentChange}\n              onFocus={handleCommentFocus}\n              onBlur={handleCommentBlur}\n              className={`w-full px-4 py-3 pr-12 bg-gray-100/80 backdrop-blur-sm rounded-xl\n                focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-black text-sm \n                resize-none placeholder-gray-500 shadow-inner\n                transition-all duration-300 ease-in-out\n                ${isCommentFocused || newComment.trim() ? 'h-24' : 'h-12'}`}\n              rows={isCommentFocused || newComment.trim() ? 3 : 1}\n              placeholder={isCommentFocused ? \"\" : \"发表评论...\"}\n              disabled={submittingComment}\n              onKeyDown={(e) => { \n                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {\n                    handleSubmitComment();\n                }\n              }}\n            />\n            <div className={`absolute bottom-3 right-3 flex items-center space-x-2\n                transition-opacity duration-300 ease-in-out\n                ${isCommentFocused || newComment.trim() ? 'opacity-100' : 'opacity-0'}`}>\n              <button\n                onClick={handleSubmitComment}\n                disabled={submittingComment || !newComment.trim() || submitCommentMutation.isPending}\n                  className={`p-2 text-blue-600 hover:text-blue-500 rounded-md transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-blue-500 ${submittingComment ? 'animate-pulse' : ''}`}\n                  title=\"提交评论 (Cmd/Ctrl+Enter)\"\n              >\n                   {submitCommentMutation.isPending ? (\n                      <svg className=\"animate-spin h-5 w-5\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\">\n                          <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                          <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                      </svg>\n                ) : (\n                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5 transform rotate-180\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" strokeWidth=\"2\">\n                         <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M3 10h10a8 8 0 018 8v2M3 10l4-4m-4 4l4 4\" />\n                 </svg>\n                )}\n              </button>\n            </div>\n          </div>\n\n          {/* 外部刷新按钮 (始终可见) */}\n          <button\n              onClick={handleRefreshComments}\n              disabled={loadingComments}\n              className=\"p-1.5 text-gray-600 hover:text-blue-600 active:text-blue-700 transition-colors duration-150 rounded-full hover:bg-gray-200/50 active:bg-gray-300/50 focus:outline-none flex-shrink-0\"\n              title=\"刷新评论\"\n          >\n              {loadingComments ? (\n                  <FaSpinner className=\"animate-spin h-4 w-4\" />\n              ) : (\n                  <motion.div\n                      key={`outer-input-refresh-${refreshAnimationKey}`}\n                      initial={{ rotate: 0 }}\n                      animate={{ rotate: 360 }}\n                      transition={{ duration: 0.4, ease: \"linear\" }}\n                      style={{ display: 'flex' }}\n                  >\n                      <FaSyncAlt className=\"h-4 w-4 block\" strokeWidth={1} />\n                  </motion.div>\n              )}\n          </button>\n        </div>\n      )}\n\n      {/* 修改: 使用虚拟滚动显示评论列表 */}\n      {loadingComments && comments.length === 0 ? (\n         <div className=\"text-center text-gray-500 py-8\">加载评论中...</div>\n      ) : isCommentError ? (\n         <div className=\"text-center text-red-400 py-8\">{commentError?.message || '加载评论失败'}</div>\n      ) : comments.length > 0 ? (\n        <div className=\"comment-list-container\" style={{ height: flattenedComments.length > 10 ? listHeight : 'auto' }}>\n          {flattenedComments.length > 10 ? (\n            /* 当评论数量足够多时，使用虚拟滚动 */\n            <div style={{ height: listHeight, width: '100%' }}>\n              <List\n                className=\"comments-virtual-list\"\n                height={listHeight}\n                width={listWidth}\n                itemCount={flattenedComments.length}\n                itemSize={itemSize}\n                overscanCount={5}\n              >\n                {CommentItem}\n              </List>\n            </div>\n          ) : (\n            /* 当评论数量较少时，直接渲染顶级评论 */\n        <div className=\"space-y-4 pb-8\">\n          {comments.map((comment) => {\n                // 直接找到评论在扁平化列表中的索引\n                const index = flattenedComments.findIndex(item => item.id === comment.id);\n                // 仅当找到有效索引时渲染\n                return index >= 0 ? CommentItem({ index, style: {} }) : null;\n          })}\n            </div>\n          )}\n        </div>\n      ) : (\n        <div className=\"text-center text-gray-500 py-8\">\n          <p>暂无评论，来发表第一条评论吧</p>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default CommentSection; "],"names":["_ref","targetType","targetId","apiBaseUrl","token","currentUser","isLiked","isCollected","likeCount","collectCount","shareCount","handleLikeToggle","handleCollectToggle","handleShareClick","isSubmittingAction","newComment","setNewComment","useState","submittingComment","setSubmittingComment","replyToCommentId","setReplyToCommentId","replyContent","setReplyContent","submittingReply","setSubmittingReply","replyTargetUser","setReplyTargetUser","sortBy","setSortBy","collapsedCommentsRef","useRef","collapsedComments","setCollapsedComments","isCommentFocused","setIsCommentFocused","authToken","user","currentUserFromAuth","useAuth","commentInputRef","replyInputRef","queryClient","useQueryClient","refreshAnimationKey","setRefreshAnimationKey","itemSize","setItemSize","flattenedComments","setFlattenedComments","listWidth","setListWidth","window","innerWidth","listHeight","useMemo","Math","min","innerHeight","initializeCollapseStateRecursively","useCallback","comments","depth","state","forEach","comment","replies","length","id","commentsQueryKey","data","isLoading","loadingComments","isError","isCommentError","error","commentError","refetch","refetchComments","useQuery","queryKey","queryFn","async","apiUrlBase","API_BASE_URL","apiUrlWithSort","fetchedComments","_response$data","axios","get","headers","Authorization","fetchCommentsAPI","staleTime","gcTime","placeholderData","previousData","enabled","useEffect","console","log","commentsData","updatedState","current","undefined","processReplies","reply","countTotalComments","commentList","count","submitCommentMutation","useMutation","mutationFn","content","mentionLynn","_ref2","postUrl","Error","requestBody","trim","mention_lynn","post","onSuccess","newCommentData","invalidateQueries","toast","success","onError","err","errorMsg","message","onSettled","handleSubmitComment","warn","toLowerCase","includes","mutate","submitReplyMutation","parentId","_ref3","replyUrl","onMutate","_ref4","cancelQueries","previousComments","getQueryData","optimisticReply","Date","now","created_at","toISOString","user_id","parent_id","likes_count","is_liked_by_current_user","_isOptimistic","is_ai_generated","setQueryData","oldComments","arguments","newComments","JSON","parse","stringify","addReplyToParent","map","newReplyData","variables","updateOptimisticReply","context","handleSubmitReply","mentionLynnForReply","deleteCommentMutation","commentId","_ref5","deleteUrl","delete","handleDeleteCommentOrReply","confirm","toggleLikeMutation","url","response","_ref6","_response$data2","status","responseData","like_count","is_liked","updateRecursively","list","c","handleLike","handleUnlike","handleReplyClick","targetUsername","setTimeout","_replyInputRef$curren","focus","_replyInputRef$curren2","toggleReplies","e","stopPropagation","newState","handleSortChange","newSortBy","preventDefault","_commentsContainerRef","scrollPos","commentsContainerRef","scrollTop","prevSortBy","requestAnimationFrame","handleReplyChange","target","value","handleRefreshComments","prevKey","info","flattened","flattenComments","isVisible","currentVisible","push","visible","findCommentById","found","CommentItem","_ref7","_comment$user$id","_comment$user","_comment$user2","_comment$user3","_comment$user3$email","_comment$user4","_comment$user5","_comment$user6","_comment$user6$email","index","style","_jsxs","className","paddingLeft","marginLeft","borderLeft","paddingTop","children","_jsx","left","top","width","height","borderBottomLeftRadius","borderBottom","minWidth","UserAvatar","userId","username","nickname","email","split","avatar","size","showName","formatDistanceToNow","addSuffix","locale","zhCN","color","is_deleted","onClick","_comment$user7","_comment$user8","_comment$user8$email","disabled","title","xmlns","viewBox","fill","fillRule","d","clipRule","isPending","stroke","strokeWidth","strokeLinecap","strokeLinejoin","ref","onChange","placeholder","rows","autoFocus","maxHeight","opacity","marginTop","transform","_Fragment","replyIndex","findIndex","item","handleResize","addEventListener","removeEventListener","MessageSquare","onFocus","handleCommentFocus","onBlur","handleCommentBlur","onKeyDown","ctrlKey","metaKey","key","cx","cy","r","FaSpinner","motion","div","initial","rotate","animate","transition","duration","ease","display","FaSyncAlt","List","itemCount","overscanCount"],"sourceRoot":""}