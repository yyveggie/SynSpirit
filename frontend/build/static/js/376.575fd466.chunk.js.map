{"version":3,"file":"static/js/376.575fd466.chunk.js","mappings":";sNAGO,MAeDA,GAAgBC,UAAAA,GAAiB,iBAfH,CAClC,CAAC,OAAQ,CAAEC,EAAG,gEAAiEC,IAAK,gGCiFtF,MAi7BA,EAn3BsDC,IAiB/C,IAjBgD,WACrDC,EAAU,SACVC,EAAQ,WACRC,EAAU,MACVC,EAAK,YACLC,EAAW,QAEXC,EAAO,YACPC,EAAW,UACXC,EAAS,aACTC,EAAY,WACZC,EAAU,iBACVC,EAAgB,oBAChBC,EAAmB,iBACnBC,EAAgB,mBAChBC,GAEDd,EAEC,MAAOe,EAAYC,IAAiBC,EAAAA,EAAAA,UAAS,KACtCC,EAAmBC,IAAwBF,EAAAA,EAAAA,WAAS,IACpDG,EAAkBC,IAAuBJ,EAAAA,EAAAA,UAAwB,OACjEK,EAAcC,IAAmBN,EAAAA,EAAAA,UAAS,KAC1CO,EAAiBC,IAAsBR,EAAAA,EAAAA,WAAS,IAChDS,EAAiBC,IAAsBV,EAAAA,EAAAA,UAAS,KAChDW,EAAQC,IAAaZ,EAAAA,EAAAA,UAA+B,UAErDa,GAAuBC,EAAAA,EAAAA,QAAmC,CAAC,IAC1DC,EAAmBC,IAAwBhB,EAAAA,EAAAA,UAAqC,CAAC,IACjFiB,EAAkBC,IAAuBlB,EAAAA,EAAAA,WAAS,IACjDb,MAAOgC,EAAWC,KAAMC,IAAwBC,EAAAA,EAAAA,KAClDC,GAAkBT,EAAAA,EAAAA,QAA4B,MAC9CU,GAAgBV,EAAAA,EAAAA,QAA4B,MAC5CW,GAAcC,EAAAA,EAAAA,OACbC,GAAqBC,KAA0B5B,EAAAA,EAAAA,UAAS,GAGzD6B,IAAqCC,EAAAA,EAAAA,cAAY,CACrDC,EACAC,EACAC,KAEAF,EAASG,SAAQC,IACXA,EAAQC,SAAWD,EAAQC,QAAQC,OAAS,IAE9CJ,EAAME,EAAQG,KAAM,EACpBT,GAAmCM,EAAQC,QAASJ,EAAQ,EAAGC,GACjE,GACA,GACD,IAGGM,GAAmB,CAAC,WAAYvD,EAAYC,EAAU0B,GAAmB,OAAXvB,QAAW,IAAXA,OAAW,EAAXA,EAAakD,KAAM,cAGrFE,KAAMT,GAAW,GACjBU,UAAWC,GACXC,QAASC,GACTC,MAAOC,GACPC,QAASC,KACPC,EAAAA,EAAAA,GAA2B,CAC7BC,SAAUX,GACVY,QAASA,IA5HYC,OAAOpE,EAAoBC,EAAkB0B,EAAgBxB,KAEpF,IAAIkE,EAAa,GACjB,GAAmB,YAAfrE,EAEFqE,EAAa,GAAGC,EAAAA,qCAA+CrE,sBAE1D,IAAmB,SAAfD,EAMT,MAAO,GAJPqE,EAAa,GAAGC,EAAAA,gBAA0BrE,YAK5C,CAIA,MAAMsE,EAAiB,GAAGF,aAAsB1C,IAIhD,IAAI6C,EAA6B,GACjC,GAAmB,SAAfxE,EAAuB,CAAC,IAADyE,EAKzBD,GAA+B,QAAbC,SAHKC,EAAAA,EAAMC,IAA6BJ,EAAgB,CACtEK,QAASzE,EAAQ,CAAE0E,cAAe,UAAU1E,KAAY,CAAC,KAElCqD,YAAI,IAAAiB,OAAA,EAAbA,EAAe1B,WAAY,EAE/C,KAAO,IAAmB,YAAf/C,EAQT,MAAO,GAHPwE,SAHuBE,EAAAA,EAAMC,IAAeJ,EAAgB,CACxDK,QAASzE,EAAQ,CAAE0E,cAAe,UAAU1E,KAAY,CAAC,KAElCqD,MAAQ,EAIrC,CAIA,OAAOgB,CAAe,EAiFLM,CAAiB9E,EAAYC,EAAU0B,EAAQQ,GAC9D4C,UAAW,IACXC,OAAQ,IACRC,gBAAkBC,GAA6B,OAAZA,QAAY,IAAZA,EAAAA,EAAgB,GACnDC,UAAWlF,KAAcD,KAI3BoF,EAAAA,EAAAA,YAAU,KACRC,QAAQC,IAEJ,CAAE7B,UAAWC,GAAiBC,QAASC,GAAgB2B,aAAcxC,IAGrE,GAEH,CAACA,GAAUW,GAAiBE,GAAgBE,GAAc9D,EAAYC,EAAU0B,KAInFyD,EAAAA,EAAAA,YAAU,KACR,GAAIrC,IAAYA,GAASM,OAAS,EAAG,CAEnC,MAAMmC,EAAe,IAAK3D,EAAqB4D,SAG/C1C,GAASG,SAAQC,IACf,GAAIA,EAAQC,SAAWD,EAAQC,QAAQC,OAAS,EAAG,MAEhBqC,IAA7BF,EAAarC,EAAQG,MACvBkC,EAAarC,EAAQG,KAAM,GAI7B,MAAMqC,EAAkBvC,IACtBA,EAAQF,SAAQ0C,IACVA,EAAMxC,SAAWwC,EAAMxC,QAAQC,OAAS,SACXqC,IAA3BF,EAAaI,EAAMtC,MACrBkC,EAAaI,EAAMtC,KAAM,GAE3BqC,EAAeC,EAAMxC,SACvB,GACA,EAGJuC,EAAexC,EAAQC,QACzB,KAIFvB,EAAqB4D,QAAUD,EAC/BxD,EAAqBwD,EACvB,IACC,CAACzC,KAGJ,MAAM8C,IAAqB/C,EAAAA,EAAAA,cAAagD,IACtC,IAAIC,EAAQ,EACZ,IAAK,MAAM5C,KAAW2C,EACpBC,IACI5C,EAAQC,SAAWD,EAAQC,QAAQC,OAAS,IAC9C0C,GAASF,GAAmB1C,EAAQC,UAGxC,OAAO2C,CAAK,GACX,IAGGC,IAAwBC,EAAAA,EAAAA,GAI5B,CACAC,WAAY9B,UAAqC,IAA9B,QAAE+B,EAAO,YAAEC,GAAaC,EAErCC,EAAU,GACd,GAAmB,YAAftG,EACFsG,EAAU,GAAGhC,EAAAA,qCAA+CrE,iBACvD,IAAmB,SAAfD,EAGT,MAAM,IAAIuG,MAAM,wCAAwCvG,KAFxDsG,EAAU,GAAGhC,EAAAA,gBAA0BrE,YAGzC,CAGA,MAAMuG,EAA2D,CAC/DL,QAASA,EAAQM,QAGfL,IACFI,EAAYE,cAAe,GAQ7B,aALuBhC,EAAAA,EAAMiC,KAC3BL,EACAE,EACA,CAAE5B,QAAS,CAAEC,cAAe,UAAU1C,QAExBqB,IAAI,EAEtBoD,UAAYC,IACVpE,EAAYqE,kBAAkB,CAAE5C,SAAU,CAAC,WAAYlE,EAAYC,KACnEc,EAAc,IACdgG,EAAAA,GAAMC,QAAQ,6CAAU,EAE1BC,QAAUC,IACR7B,QAAQxB,MAAM,wCAAWqD,GACzB,MAAMC,EAAWD,EAAIE,SAAW,uCAChCL,EAAAA,GAAMlD,MAAMsD,EAAS,EAEvBE,UAAWA,KACTnG,GAAqB,EAAM,IAIzBoG,GAAsBA,KAC1B,IAAKnF,IAAcrB,EAAW2F,OAE5B,YADAM,EAAAA,GAAMQ,KAAK,wFAGbrG,GAAqB,GAGrB,MAAMkF,EAActF,EAAW0G,cAAcC,SAAS,SAEtDzB,GAAsB0B,OAAO,CAAEvB,QAASrF,EAAYsF,eAAc,EAI9DuB,IAAsB1B,EAAAA,EAAAA,GAK1B,CACAC,WAAY9B,UAA+C,IAAxC,SAAEwD,EAAQ,QAAEzB,EAAO,YAAEC,GAAayB,EAE/CC,EAAW,GACf,GAAmB,YAAf9H,EACF8H,EAAW,GAAGxD,EAAAA,qCAA+CrE,cAAqB2H,gBAC7E,IAAmB,SAAf5H,EAGT,MAAM,IAAIuG,MAAM,sCAAsCvG,KAFtD8H,EAAW,GAAGxD,EAAAA,gBAA0BrE,cAAqB2H,WAG/D,CAWA,MAAMpB,EAA2D,CAC/DL,QAASA,EAAQM,QAGfL,IACFI,EAAYE,cAAe,GAY7B,aATuBhC,EAAAA,EAAMiC,KAC3BmB,EACAtB,EACA,CAAE5B,QAAS,CAAEC,cAAe,UAAU1C,QAMxBqB,IAAI,EAGtBuE,SAAU3D,UAAkC,IAA3B,SAAEwD,EAAQ,QAAEzB,GAAS6B,QAE9BvF,EAAYwF,cAAc,CAAE/D,SAAUX,KAG5C,MAAM2E,EAAmBzF,EAAY0F,aAAwB5E,KAAqB,GAG5E6E,EAA2B,CAC/B9E,GAAI+E,KAAKC,MACTnC,QAASA,EACToC,YAAY,IAAIF,MAAOG,cACvBC,SAAoB,OAAXrI,QAAW,IAAXA,OAAW,EAAXA,EAAakD,KAAM,KAC5BoF,UAAWd,EACXxF,KAAMhC,EACNgD,QAAS,GACTuF,YAAa,EACbC,0BAA0B,EAC1BC,eAAe,EACfC,iBAAiB,GAqCnB,OAjCArG,EAAYsG,aAAwBxF,IAAkB,WAAuB,IAAtByF,EAAWC,UAAA5F,OAAA,QAAAqC,IAAAuD,UAAA,GAAAA,UAAA,GAAG,GAEnE,MAAMC,EAAcC,KAAKC,MAAMD,KAAKE,UAAUL,IAGxCM,EAAoBvG,GACjBA,EAASwG,KAAIpG,GACdA,EAAQG,KAAOsE,EAEV,IACFzE,EACHC,QAAS,IAAKD,EAAQC,SAAW,GAAKgF,IAKtCjF,EAAQC,SAAWD,EAAQC,QAAQC,OAAS,EACvC,IACFF,EACHC,QAASkG,EAAiBnG,EAAQC,UAI/BD,IAIX,OAAOmG,EAAiBJ,EAC1B,IAKO,CAAEhB,mBAAkB,EAG7BtB,UAAWA,CAAC4C,EAAcC,KAKxBhH,EAAYsG,aAAwBxF,IAAkB,WAAuB,IAAtByF,EAAWC,UAAA5F,OAAA,QAAAqC,IAAAuD,UAAA,GAAAA,UAAA,GAAG,GACnE,IAAKD,EAAY3F,OAGf,OADAZ,EAAYqE,kBAAkB,CAAE5C,SAAUX,KACnCyF,EAIT,MAAME,EAAcC,KAAKC,MAAMD,KAAKE,UAAUL,IAGxCU,EAAyB3G,GACtBA,EAASwG,KAAIpG,GACdA,EAAQG,KAAOmG,EAAU7B,SACpB,IACFzE,EACHC,QAASD,EAAQC,QAAQmG,KAAI3D,GAE1BA,EAAMiD,cAAiBW,EAAe5D,KAKzCzC,EAAQC,SAAWD,EAAQC,QAAQC,OAAS,EACvC,IACFF,EACHC,QAASsG,EAAsBvG,EAAQC,UAIpCD,IAIX,OAAOuG,EAAsBR,EAC/B,IAGA5H,EAAgB,IAChBF,EAAoB,MACpB2F,EAAAA,GAAMC,QAAQ,iCAAQ,EAExBC,QAASA,CAACC,EAAKuC,EAAWE,KACxBtE,QAAQxB,MAAM,wCAAWqD,GACzBH,EAAAA,GAAMlD,MAAMqD,EAAIE,SAAW,wCAIhB,OAAPuC,QAAO,IAAPA,GAAAA,EAASzB,kBACXzF,EAAYsG,aAAaxF,GAAkBoG,EAAQzB,iBACrD,EAGFb,UAAWA,KACT7F,GAAmB,EAAM,IAkBvBoI,IAAwB3D,EAAAA,EAAAA,GAI5B,CACAC,WAAY9B,UAA0B,IAAnB,UAAEyF,GAAWC,EAE1BC,EAAY,GAChB,GAAmB,YAAf/J,EAEF+J,EAAY,GAAGzF,EAAAA,qCAA+CrE,cAAqB4J,QAC9E,IAAmB,SAAf7J,EAGR,MAAM,IAAIuG,MAAM,wCAAwCvG,KAFzD+J,EAAY,GAAGzF,EAAAA,gBAA0BrE,cAAqB4J,GAGhE,OACMnF,EAAAA,EAAMsF,OAAOD,EAAW,CAAEnF,QAAS,CAAEC,cAAe,UAAU1C,MAAgB,EAEtFyE,UAAWA,KACTnE,EAAYqE,kBAAkB,CAAE5C,SAAU,CAAC,WAAYlE,EAAYC,KACnE8G,EAAAA,GAAMC,QAAQ,iCAAQ,EAExBC,QAAUC,IACR7B,QAAQxB,MAAM,wCAAWqD,GACzBH,EAAAA,GAAMlD,MAAMqD,EAAIE,SAAW,uCAAS,IAgBlC6C,IAAqBhE,EAAAA,EAAAA,GAIzB,CACAC,WAAY9B,UAAmC,IACzC8F,EAiBAC,GAlBa,UAAEN,EAAS,QAAExJ,GAAS+J,EAyBgD,IAADC,EAAtF,GAtBmB,SAAfrK,EAEFkK,EAAM,GAAG5F,EAAAA,8BAAwCuF,SACzB,YAAf7J,EAGTkK,EAAM,GAAG5F,EAAAA,qCAA+CuF,UAExDxE,QAAQxB,MAAM,2DAA2D7D,KAEzEkK,EAAM,GAAG5F,EAAAA,mBAA6BuF,sBAA8B7J,KAOpEmK,EADE9J,QACeqE,EAAAA,EAAMsF,OAAOE,EAAK,CAAEtF,QAAS,CAAEC,cAAe,UAAU1C,aAExDuC,EAAAA,EAAMiC,KAAKuD,EAAK,CAAC,EAAG,CAAEtF,QAAS,CAAEC,cAAe,UAAU1C,OAGnD,MAApBgI,EAASG,QAAsC,MAApBH,EAASG,QAAsC,MAApBH,EAASG,OAClE,MAAM,IAAI/D,OAAmB,QAAb8D,EAAAF,EAAS3G,YAAI,IAAA6G,OAAA,EAAbA,EAAejD,UAAW,yBAI7C,MAAMmD,EAAeJ,EAAS3G,MAAQ,CAAC,EASvC,MAPe,CACbmF,iBAA0CjD,IAA7B6E,EAAa5B,YAA4B4B,EAAa5B,YAAe4B,EAAaC,YAAc,EAC7G5B,8BAAoElD,IAA1C6E,EAAa3B,yBACnC2B,EAAa3B,yBACb2B,EAAaE,SAGN,EAEf7D,UAAWA,CAACpD,EAAMiG,KAChBhH,EAAYsG,aAAaxF,IAAkB,WACzC,MAAMmH,EAAqBC,GAA+BA,EAAKpB,KAAIqB,GAC7DA,EAAEtH,KAAOmG,EAAUI,UACd,IACFe,EAEHjC,YAAanF,EAAKmF,YAClBC,yBAA0BpF,EAAKoF,0BAG/BgC,EAAExH,SAAWwH,EAAExH,QAAQC,OAAS,EAC3B,IAAKuH,EAAGxH,QAASsH,EAAkBE,EAAExH,UAEvCwH,IAET,OAAOF,EAfiEzB,UAAA5F,OAAA,QAAAqC,IAAAuD,UAAA,GAAAA,UAAA,GAAG,GAgB7E,GAAE,EAEJhC,QAASA,CAACC,EAAKuC,KACbpE,QAAQxB,MAAM,2BAAkBqD,GAChCH,EAAAA,GAAMlD,MAAM,6BAASqD,EAAIE,UAAU,IA4DjCyD,GAAmBA,CAACC,EAAqBC,KAI7C,GAHAD,EAAEE,iBACFF,EAAEG,kBAEEtJ,IAAWoJ,EAAW,CAAC,IAADG,EACxB,MAAMC,GAAwC,QAA5BD,EAAAE,GAAqB3F,eAAO,IAAAyF,OAAA,EAA5BA,EAA8BG,YAAa,EAE7DzJ,GAAU0J,IACRjG,QAAQC,IAAI,iCAAQgG,QAAiBP,KAC9BA,KAIT/G,KAEAuH,uBAAsB,KAChBH,GAAqB3F,UACvB2F,GAAqB3F,QAAQ4F,UAAYF,EAC3C,GAEJ,GAOIK,GAAqBV,IACzBxJ,EAAgBwJ,EAAEW,OAAOC,MAAM,EAW3BN,IAAuBtJ,EAAAA,EAAAA,QAAuB,MAG9C6J,IAAwB7I,EAAAA,EAAAA,cAAY,KACnCY,IACDd,IAAuBgJ,GAAWA,EAAU,IAE5C5H,IACAA,KACA+C,EAAAA,GAAM8E,KAAK,6CAEXxG,QAAQxB,MAAM,8CACdkD,EAAAA,GAAMlD,MAAM,sEAChB,GACC,CAACH,GAAiBM,KAIf8H,GAAgB,SAAC3I,GAAiC,IAAD4I,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAA,IAAdrJ,EAAKiG,UAAA5F,OAAA,QAAAqC,IAAAuD,UAAA,GAAAA,UAAA,GAAG,EAC/C,MACMqD,EAAcnJ,EAAQ2F,iBACO,QAAZiD,EAAA5I,EAAQf,YAAI,IAAA2J,OAAA,EAAZA,EAAcQ,WAAY,QACd,QAAZP,EAAA7I,EAAQf,YAAI,IAAA4J,OAAA,EAAZA,EAAcO,YAAwB,QAAhBN,EAAI9I,EAAQf,YAAI,IAAA6J,GAAO,QAAPC,EAAZD,EAAcO,aAAK,IAAAN,OAAP,EAAZA,EAAqBO,MAAM,KAAK,KAAM,2BACjFC,EAAavL,IAAqBgC,EAAQG,GAC1CqJ,EAAYvM,GAAe+C,EAAQf,MAAQhC,EAAYkD,KAAOH,EAAQf,KAAKkB,KAAOH,EAAQyJ,aAAezJ,EAAQ2F,gBACjH+D,EAAuB1J,EAAQyF,yBAC/BkE,EAAmB3J,EAAQwF,YAC3BoE,GAAmC,IAAvB5J,EAAQyJ,WACpBI,GAAsD,IAAlCjL,EAAkBoB,EAAQG,IAC9C2J,EAAa9J,EAAQC,SAAWD,EAAQC,QAAQC,OAAS,EACzD6J,EAAeD,EAAapH,GAAmB1C,EAAQC,SAAW,EAExE,OACE+J,EAAAA,EAAAA,MAAA,OAAsBC,UAAW,gBAAgBpK,EAAQ,EAAI,eAAiB,mBAAmBqK,SAAA,CAC7FrK,EAAQ,IACNsK,EAAAA,EAAAA,KAAA,OAAKF,UAAU,iEACbG,MAAO,CAAEC,IAAK,SAAUC,OAAQ,aAErCN,EAAAA,EAAAA,MAAA,OAAKC,UAAU,4CAA2CC,SAAA,CAEtDJ,IACGK,EAAAA,EAAAA,KAAA,UACII,QAAU5C,GA9FN6C,EAAC9D,EAAmBiB,KACvC,OAADA,QAAC,IAADA,GAAAA,EAAGG,kBAEH,MAAM2C,EAAW,IACZ7L,EACH,CAAC8H,IAAa9H,EAAkB8H,IAIlChI,EAAqB4D,QAAUmI,EAC/B5L,EAAqB4L,EAAS,EAoFED,CAAcxK,EAAQG,GAAIwH,GAC1CsC,UAAU,sIACVG,MAAO,CACLM,WAAY7K,EAAQ,EAAI,QAAU,IAClC8K,MAAO,OACPC,UAAW,SACXC,SAAU,QAEZ,aAAYhB,EAAoB,2BAAS,2BAAOK,SAC/CL,EAAoB,KAAKE,KAAkB,SAGpDI,EAAAA,EAAAA,KAACW,EAAAA,EAAU,CAACC,OAAwB,QAAlB/B,EAAc,QAAdC,EAAEjJ,EAAQf,YAAI,IAAAgK,OAAA,EAAZA,EAAc9I,UAAE,IAAA6I,EAAAA,OAAIzG,EAC5ByI,SAAU7B,EACV8B,OAAoB,QAAd/B,EAAElJ,EAAQf,YAAI,IAAAiK,OAAA,EAAZA,EAAc+B,OACtBC,KAAK,KACLC,UAAU,KAEtBnB,EAAAA,EAAAA,MAAA,OAAKC,UAAU,qDAAoDC,SAAA,EAC/DC,EAAAA,EAAAA,KAAA,QAAMF,UAAW,wBAAuBjK,EAAQ2F,gBAAkB,kBAAqB3F,EAAQf,KAAO,gBAAkB,iBAAmBiL,SACxIf,KAEPgB,EAAAA,EAAAA,KAAA,QAAMF,UAAU,qCAAoCC,UAC7CkB,EAAAA,EAAAA,GAAoB,IAAIlG,KAAKlF,EAAQoF,YAAa,CAAEiG,WAAW,EAAMC,OAAQC,EAAAA,aAIvFvB,EAAAA,EAAAA,MAAA,OAAKC,UAAW,IAAGpK,EAAQ,EAAI,OAAS,QAASqK,SAAA,EAC9CC,EAAAA,EAAAA,KAAA,KAAGF,UAAW,iDAAgDL,EAAY,uBAAyB,iBAAkBM,SAClHlK,EAAQgD,WAEXmH,EAAAA,EAAAA,KAAA,OAAKF,UAAU,mCAAkCC,UAC3CN,IACEI,EAAAA,EAAAA,MAAAwB,EAAAA,SAAA,CAAAtB,SAAA,EACIC,EAAAA,EAAAA,KAAA,UAAQI,QAASA,KAAMkB,OAhKnB/E,EAgKoC1G,EAAQG,GAhKzBuL,EAgK6BvC,OA/JpEnL,IAAqB0I,GACvBzI,EAAoB,MACpBM,EAAmB,IACnBJ,EAAgB,KAES,OAArBH,GACFC,EAAoB,MACpBM,EAAmB,IACnBJ,EAAgB,IAChBwN,YAAW,KACb1N,EAAoByI,GACpBnI,EAAmBmN,GACnBvN,EAAgB,IACZwN,YAAW,KAAO,IAADC,EAAuB,QAArBA,EAAAvM,EAAciD,eAAO,IAAAsJ,GAArBA,EAAuBC,OAAO,GAAK,GAAG,GACxD,MAEH5N,EAAoByI,GACpBnI,EAAmBmN,GACnBvN,EAAgB,IAChBwN,YAAW,KAAO,IAADG,EAAuB,QAArBA,EAAAzM,EAAciD,eAAO,IAAAwJ,GAArBA,EAAuBD,OAAO,GAAK,MApBnCJ,IAAC/E,EAAmBgF,CAgK0C,EACvEzB,UAAW,WAAWV,EAAa,gBAAkB,wDAC3CwC,UAAW/M,EAAWgN,MAAQhN,EAAsBuK,EAAa,2BAAS,eAAhC,2BAAsCW,UAChFC,EAAAA,EAAAA,KAAA,OAAK8B,MAAM,6BAA6BhC,UAAU,cAAciC,QAAQ,YAAYC,KAAK,eAAcjC,UAACC,EAAAA,EAAAA,KAAA,QAAMiC,SAAS,UAAU1P,EAAE,sKAAsK2P,SAAS,iBAErTrC,EAAAA,EAAAA,MAAA,UAAQO,QAASA,KAAMvL,SAAa0K,GA3KrChD,EA2KyE1G,EAAQG,QA1KhGnB,EACL8H,GAAmBvC,OAAO,CAAEmC,YAAWxJ,SAAS,IAD9B0G,EAAAA,GAAMQ,KAAK,8BANXsC,KACb1H,EACL8H,GAAmBvC,OAAO,CAAEmC,YAAWxJ,SAAS,IAD9B0G,EAAAA,GAAMQ,KAAK,2BAC2B,EA8KmDkI,CAAWtM,EAAQG,IAAOyD,EAAAA,GAAMQ,KAAK,8CA3K5HsC,KA2KuI,EACnIuD,UAAW,6DAA4DP,EAAuB,oCAAsC,qCACpIqC,UAAW/M,GAAa8H,GAAmByF,UAAWP,MAAQhN,EAAsB0K,EAAuB,2BAAS,eAA1C,2BAAgDQ,SAAA,CACzHR,GACGS,EAAAA,EAAAA,KAAA,OAAK8B,MAAM,6BAA6BhC,UAAU,cAAciC,QAAQ,YAAYC,KAAK,eAAcjC,UAACC,EAAAA,EAAAA,KAAA,QAAMiC,SAAS,UAAU1P,EAAE,gHAAgH2P,SAAS,eAE5PlC,EAAAA,EAAAA,KAAA,OAAK8B,MAAM,6BAA6BhC,UAAU,cAAckC,KAAK,OAAOD,QAAQ,YAAYM,OAAO,eAAeC,YAAY,IAAGvC,UAACC,EAAAA,EAAAA,KAAA,QAAMuC,cAAc,QAAQC,eAAe,QAAQjQ,EAAE,mIAG/LyN,EAAAA,EAAAA,KAAA,QAAMF,UAAU,eAAeG,MAAO,CAAEwC,QAAS,eAAgB/B,SAAU,OAAQD,UAAW,OAAQF,WAAY,YAAaR,SAC5HP,EAAmB,EAAIA,EAAmB,QAGxDH,IACSW,EAAAA,EAAAA,KAAA,UAAQI,QAASA,KAAMsC,OAjRXnG,EAiRsC1G,EAAQG,QAhR3EnB,EAIA8N,OAAOC,QAAQ,yLAGpBtG,GAAsBlC,OAAO,CAAEmC,cAN7B9C,EAAAA,GAAMlD,MAAM,mCAFoBgG,KAiRkD,EAC1DuD,UAAU,6DAA6D+B,MAAM,2BAAM9B,UACnFC,EAAAA,EAAAA,KAAA,OAAK8B,MAAM,6BAA6BhC,UAAU,cAAciC,QAAQ,YAAYC,KAAK,eAAcjC,UAACC,EAAAA,EAAAA,KAAA,QAAMiC,SAAS,UAAU1P,EAAE,8MAA8M2P,SAAS,qBAMzWrO,IAAqBgC,EAAQG,KAC5B6J,EAAAA,EAAAA,MAAA,OAAKC,UAAU,uBAAsBC,SAAA,EAClCC,EAAAA,EAAAA,KAAA,YAAU6C,IAAK3N,EAAekJ,MAAOrK,EAAc+O,SAAU5E,GAC5D6E,YAAa,gBAAM5O,OAAsB6O,KAAM,EAC/ClD,UAAU,8IACVmD,WAAS,KACXjD,EAAAA,EAAAA,KAAA,OAAKF,UAAU,wDAAuDC,UACnEC,EAAAA,EAAAA,KAAA,UAAQI,QAASA,IA1UT9F,KACzB,IAAKzF,IAAcd,EAAaoF,OAE9B,YADAM,EAAAA,GAAMQ,KAAK,wFAGb/F,GAAmB,GAGnB,MAAMgP,EAAsBnP,EAAamG,cAAcC,SAAS,SAEhEE,GAAoBD,OAAO,CAAEE,WAAUzB,QAAS9E,EAAc+E,YAAaoK,GAAsB,EAgUzDC,CAAkBtN,EAAQG,IAC/C4L,SAAU3N,IAAoBF,EAAaoF,OAAQ0I,MAAM,eACzD/B,UAAW,sJAAqJ7L,EAAkB,gBAAkB,IAAK8L,UACvMC,EAAAA,EAAAA,KAAA,OAAK8B,MAAM,6BAA6BhC,UAAU,+BAA+BkC,KAAK,OAAOD,QAAQ,YAAYM,OAAO,eAAeC,YAAY,IAAGvC,UAACC,EAAAA,EAAAA,KAAA,QAAMuC,cAAc,QAAQC,eAAe,QAAQjQ,EAAE,yDAM3NoN,IAAeD,IACZM,EAAAA,EAAAA,KAAA,OAAKF,UAAU,iDAAgDC,SAC9DlK,EAAQC,QAAQmG,KAAI3D,GAASkG,GAAclG,EAAO5C,EAAQ,SAxFxDG,EAAQG,GA6FtB,EAGA,OACE6J,EAAAA,EAAAA,MAAA,OAAKC,UAAU,yCAAyC+C,IAAK/E,GAAqBiC,SAAA,EAEhFF,EAAAA,EAAAA,MAAA,OAAKC,UAAU,yCAAwCC,SAAA,EAEpDF,EAAAA,EAAAA,MAAA,OAAKC,UAAU,8BAA6BC,SAAA,EAEzCF,EAAAA,EAAAA,MAAA,OAAKC,UAAU,0CAAyCC,SAAA,EAEpDC,EAAAA,EAAAA,KAAC3N,EAAa,CAAC0O,KAAM,GAAIjB,UAAU,UACnCD,EAAAA,EAAAA,MAAA,QAAMC,UAAU,eAAcC,SAAA,CAAC,IAAExH,GAAmB9C,IAAU,WAGlEoK,EAAAA,EAAAA,MAAA,UACEO,QAAShN,EACT0M,UAAW,iHACP/M,EAAU,yDAA2D,+EACpEF,GAAS,kCACd+O,UAAW/O,EACXgP,MAAQhP,EAAkBE,EAAU,2BAAS,eAA7B,2BAAmCgN,SAAA,EAEnDC,EAAAA,EAAAA,KAAA,OAAK8B,MAAM,6BAA6BhC,UAAU,UAAUiC,QAAQ,YAAYC,KAAK,eAAcjC,UACjGC,EAAAA,EAAAA,KAAA,QAAMiC,SAAS,UAAU1P,EAAE,gHAAgH2P,SAAS,eAEtJrC,EAAAA,EAAAA,MAAA,QAAMC,UAAU,eAAcC,SAAA,CAAC,IAAE9M,EAAU,WAG7C4M,EAAAA,EAAAA,MAAA,UACEO,QAAS/M,EACTyM,UAAW,iHACP9M,EAAc,+DAAiE,+EAC9EH,GAAS,kCACd+O,UAAW/O,EACXgP,MAAQhP,EAAkBG,EAAc,2BAAS,eAAjC,2BAAuC+M,SAAA,EAEvDC,EAAAA,EAAAA,KAAA,OAAK8B,MAAM,6BAA6BhC,UAAU,UAAUiC,QAAQ,YAAYC,KAAK,eAAcjC,UACjGC,EAAAA,EAAAA,KAAA,QAAMzN,EAAE,wDAEVsN,EAAAA,EAAAA,MAAA,QAAMC,UAAU,eAAcC,SAAA,CAAC,IAAE7M,EAAa,WAGlD2M,EAAAA,EAAAA,MAAA,UACIO,QAAS9M,EACTwM,UAAW,2LAENjN,GAAS,kCACd+O,UAAW/O,EACXgP,MAAQhP,EAAiB,eAAT,2BAAckN,SAAA,EAE9BC,EAAAA,EAAAA,KAAA,OAAK8B,MAAM,6BAA6BhC,UAAU,UAAUkC,KAAK,OAAOD,QAAQ,YAAYM,OAAO,eAAeC,YAAa,EAAEvC,UAC/HC,EAAAA,EAAAA,KAAA,QAAMuC,cAAc,QAAQC,eAAe,QAAQjQ,EAAE,4OAEtDY,EAAa,IAAK0M,EAAAA,EAAAA,MAAA,QAAMC,UAAU,eAAcC,SAAA,CAAC,IAAE5M,EAAW,cAMpE0M,EAAAA,EAAAA,MAAA,OAAKC,UAAU,8BAA6BC,SAAA,EACrCC,EAAAA,EAAAA,KAAA,UACFI,QAAU5C,GAAMD,GAAiBC,EAAG,UACpCsC,UAAW,0EACE,WAAXzL,EACI,+CACA,0FACH0L,SACA,kBAGDC,EAAAA,EAAAA,KAAA,UACFI,QAAU5C,GAAMD,GAAiBC,EAAG,WACpCsC,UAAW,0EACE,YAAXzL,EACI,+CACA,0FACH0L,SACA,uBASVlN,GAASC,IACR+M,EAAAA,EAAAA,MAAA,OAAKC,UAAU,mCAAkCC,SAAA,EAC/CF,EAAAA,EAAAA,MAAA,OAAKC,UAAU,qBAAoBC,SAAA,EACjCC,EAAAA,EAAAA,KAAA,YACE6C,IAAK5N,EACLmJ,MAAO5K,EACPsP,SA5OiBtF,IAC3B/J,EAAc+J,EAAEW,OAAOC,MAAM,EA4OnBgF,QArOeC,IAAMzO,GAAoB,GAsOzC0O,OArOcC,KACnB/P,EAAW2F,QACdvE,GAAoB,EAClB,EAmOMkL,UAAW,2SAIPnL,GAAoBnB,EAAW2F,OAAS,OAAS,QACrD6J,KAAMrO,GAAoBnB,EAAW2F,OAAS,EAAI,EAClD4J,YAAapO,EAAmB,GAAK,8BACrCiN,SAAUjO,EACV6P,UAAYhG,KACLA,EAAEiG,SAAWjG,EAAEkG,UAAsB,UAAVlG,EAAEhL,KAC9BwH,IACJ,KAGJgG,EAAAA,EAAAA,KAAA,OAAKF,UAAW,wIAEVnL,GAAoBnB,EAAW2F,OAAS,cAAgB,aAAc4G,UAC1EC,EAAAA,EAAAA,KAAA,UACEI,QAASpG,GACT4H,SAAUjO,IAAsBH,EAAW2F,QAAUT,GAAsB0J,UACzEtC,UAAW,oOAAmOnM,EAAoB,gBAAkB,IACpRkO,MAAM,4CAAuB9B,SAE3BrH,GAAsB0J,WACpBvC,EAAAA,EAAAA,MAAA,OAAKC,UAAU,uBAAuBgC,MAAM,6BAA6BE,KAAK,OAAOD,QAAQ,YAAWhC,SAAA,EACpGC,EAAAA,EAAAA,KAAA,UAAQF,UAAU,aAAa6D,GAAG,KAAKC,GAAG,KAAKC,EAAE,KAAKxB,OAAO,eAAeC,YAAY,OACxFtC,EAAAA,EAAAA,KAAA,QAAMF,UAAU,aAAakC,KAAK,eAAezP,EAAE,wHAGvDyN,EAAAA,EAAAA,KAAA,OAAK8B,MAAM,6BAA6BhC,UAAU,+BAA+BkC,KAAK,OAAOD,QAAQ,YAAYM,OAAO,eAAeC,YAAY,IAAGvC,UACnJC,EAAAA,EAAAA,KAAA,QAAMuC,cAAc,QAAQC,eAAe,QAAQjQ,EAAE,uDAQpEyN,EAAAA,EAAAA,KAAA,UACII,QAAS/B,GACTuD,SAAUxL,GACV0J,UAAU,uLACV+B,MAAM,2BAAM9B,SAEX3J,IACG4J,EAAAA,EAAAA,KAAC8D,EAAAA,GAAS,CAAChE,UAAU,0BAErBE,EAAAA,EAAAA,KAAC+D,EAAAA,EAAOC,IAAG,CAEPC,QAAS,CAAEC,OAAQ,GACnBC,QAAS,CAAED,OAAQ,KACnBE,WAAY,CAAEC,SAAU,GAAKC,KAAM,UACnCrE,MAAO,CAAEwC,QAAS,QAAS1C,UAE3BC,EAAAA,EAAAA,KAACuE,EAAAA,IAAS,CAACzE,UAAU,mBANhB,uBAAuBzK,WAc3Ce,IAAuC,IAApBX,GAASM,QAC1BiK,EAAAA,EAAAA,KAAA,OAAKF,UAAU,iCAAgCC,SAAC,sCAC/CzJ,IACD0J,EAAAA,EAAAA,KAAA,OAAKF,UAAU,gCAA+BC,UAAc,OAAZvJ,SAAY,IAAZA,QAAY,EAAZA,GAAcsD,UAAW,yCACxErE,GAASM,OAAS,GACpBiK,EAAAA,EAAAA,KAAA,OAAKF,UAAU,iBAAgBC,SAC5BtK,GAASwG,KAAKpG,GACN2I,GAAc3I,QAIzBmK,EAAAA,EAAAA,KAAA,OAAKF,UAAU,iCAAgCC,UAC7CC,EAAAA,EAAAA,KAAA,KAAAD,SAAG,6FAGH","sources":["../node_modules/lucide-react/src/icons/message-square.ts","components/CommentSection.tsx"],"sourcesContent":["import createLucideIcon from '../createLucideIcon';\nimport { IconNode } from '../types';\n\nexport const __iconNode: IconNode = [\n  ['path', { d: 'M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z', key: '1lielz' }],\n];\n\n/**\n * @component @name MessageSquare\n * @description Lucide SVG icon component, renders SVG Element with children.\n *\n * @preview ![img](data:image/svg+xml;base64,PHN2ZyAgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogIHdpZHRoPSIyNCIKICBoZWlnaHQ9IjI0IgogIHZpZXdCb3g9IjAgMCAyNCAyNCIKICBmaWxsPSJub25lIgogIHN0cm9rZT0iIzAwMCIgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6ICNmZmY7IGJvcmRlci1yYWRpdXM6IDJweCIKICBzdHJva2Utd2lkdGg9IjIiCiAgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIgogIHN0cm9rZS1saW5lam9pbj0icm91bmQiCj4KICA8cGF0aCBkPSJNMjEgMTVhMiAyIDAgMCAxLTIgMkg3bC00IDRWNWEyIDIgMCAwIDEgMi0yaDE0YTIgMiAwIDAgMSAyIDJ6IiAvPgo8L3N2Zz4K) - https://lucide.dev/icons/message-square\n * @see https://lucide.dev/guide/packages/lucide-react - Documentation\n *\n * @param {Object} props - Lucide icons props and any valid SVG attribute\n * @returns {JSX.Element} JSX Element\n *\n */\nconst MessageSquare = createLucideIcon('message-square', __iconNode);\n\nexport default MessageSquare;\n","/**\n * CommentSection.tsx\n * \n * 此组件负责渲染和管理特定目标（文章或帖子）的评论区。\n * \n * 主要功能:\n * - 使用 TanStack Query (`useQuery`) 获取并缓存评论列表，管理加载和错误状态。\n * - 根据 Query Key (`['comments', targetType, targetId, sortBy]`) 区分不同排序的缓存。\n * - 使用 `placeholderData` 优化排序切换时的 UI 体验，避免闪烁。\n * - 使用 TanStack Query (`useMutation`) 处理评论的创建、回复、删除和点赞操作，并自动或手动更新缓存。\n * - 显示评论列表 (包括嵌套的回复)，并支持折叠/展开。\n * - 提供顶层评论的输入框。\n * - 支持对现有评论进行回复。\n * - 根据用户登录状态控制评论、回复和删除权限。\n * \n * 注意: 如果新增、删除或修改功能，必须在这开头的注释中同步修改，\n * 如发现功能与注释描述不同，也可以在确定后修改。\n */\nimport React, { useState, useEffect, useCallback, useRef } from 'react';\nimport axios from 'axios';\nimport { toast } from 'react-toastify';\nimport { Link } from 'react-router-dom';\nimport { formatDistanceToNow } from 'date-fns';\nimport { zhCN } from 'date-fns/locale';\nimport { useAuth } from '../context/AuthContext';\nimport { MessageSquare } from 'lucide-react';\nimport UserAvatar from './UserAvatar';\n// --- TanStack Query Import ---\nimport { useQuery, useQueryClient, useMutation } from '@tanstack/react-query';\n// --- End TanStack Query Import ---\nimport { API_BASE_URL } from '../config';\nimport { FaHeart, FaRegHeart, FaSpinner, FaReply, FaTrashAlt, FaSyncAlt } from 'react-icons/fa';\nimport { BsArrowReturnRight, BsTrash } from 'react-icons/bs';\nimport { motion } from 'framer-motion';\n\n// --- 接口定义 ---\ninterface UserInfo {\n  id: number;\n  nickname?: string | null;\n  email?: string;\n  avatar?: string | null; // 确保包含头像\n}\n\ninterface Comment {\n  id: number;\n  content: string;\n  created_at: string;\n  post_id?: number; // 根据 targetType 确定\n  article_id?: number; // 根据 targetType 确定\n  user_id: number | null;\n  parent_id: number | null;\n  user: UserInfo | null;\n  replies: Comment[];\n  likes_count: number;\n  is_liked_by_current_user: boolean;\n  is_deleted?: boolean; // 新增：软删除标记\n  _isOptimistic?: boolean; // 新增：标记乐观更新的临时对象\n  is_ai_generated: boolean;\n}\n\n// 定义乐观更新上下文类型\ninterface ReplyMutationContext {\n  previousComments: Comment[];\n}\n\ninterface CommentSectionProps {\n  targetType: 'post' | 'article'; // 评论目标类型\n  targetId: number;               // 评论目标ID\n  apiBaseUrl: string;             // API基础URL\n  token: string | null;           // 用户认证令牌\n  currentUser: UserInfo | null;   // 当前登录用户信息\n  // --- 新增：点赞、收藏、分享相关 Props ---\n  isLiked: boolean;               // 目标是否已点赞\n  isCollected: boolean;           // 目标是否已收藏\n  likeCount: number;              // 点赞数\n  collectCount: number;           // 收藏数\n  shareCount: number;             // 分享数\n  handleLikeToggle: () => void;   // 处理点赞切换\n  handleCollectToggle: () => void; // 处理收藏切换\n  handleShareClick: () => void;   // 处理分享点击\n  isSubmittingAction: boolean;    // 操作（点赞/收藏/分享）是否正在提交\n  // --- 结束新增 ---\n}\n\n// --- API Fetching Function (移除客户端排序) ---\nconst fetchCommentsAPI = async (targetType: string, targetId: number, sortBy: string, token: string | null) => {\n  // --- 修改：根据 targetType 动态构建 API URL --- \n  let apiUrlBase = '';\n  if (targetType === 'article') {\n    // 文章评论使用新的 /tree 端点获取完整树\n    apiUrlBase = `${API_BASE_URL}/api/original-comments/articles/${targetId}/comments/tree`; \n    // console.log(`[CommentSection DEBUG] Base URL for article comments: ${apiUrlBase}`);\n  } else if (targetType === 'post') {\n    // 帖子评论使用其标准端点获取完整树\n    apiUrlBase = `${API_BASE_URL}/api/posts/${targetId}/comments`; // 这个端点应该返回完整树\n    // console.log(`[CommentSection DEBUG] Base URL for post comments: ${apiUrlBase}`);\n  } else {\n    // console.error(`[CommentSection ERROR] Unknown targetType: ${targetType}`);\n    return []; \n  }\n  // --- 结束修改 ---\n\n  // 将 sortBy 参数添加到 URL\n  const apiUrlWithSort = `${apiUrlBase}?sort_by=${sortBy}`;\n  // console.log(`[CommentSection DEBUG] Fetching comments from: ${apiUrlWithSort}`);\n  \n  // --- 修改：根据 targetType 判断期望的响应结构 ---\n  let fetchedComments: Comment[] = [];\n  if (targetType === 'post') {\n    // 帖子评论 API 可能返回 { comments: [] }\n    const response = await axios.get<{ comments: Comment[] }>(apiUrlWithSort, { \n        headers: token ? { Authorization: `Bearer ${token}` } : {},\n    });\n    fetchedComments = response.data?.comments || [];\n    // console.log(`[CommentSection DEBUG] Post comments raw response data:`, response.data);\n  } else if (targetType === 'article') {\n    // 文章评论 API 直接返回 []\n    const response = await axios.get<Comment[]>(apiUrlWithSort, { \n        headers: token ? { Authorization: `Bearer ${token}` } : {},\n    });\n    fetchedComments = response.data || [];\n  } else {\n    // 未知类型，返回空数组，错误已在上面记录\n    return [];\n  }\n  // --- 结束修改 ---\n  \n  // console.log(`[CommentSection DEBUG] Data received in fetchCommentsAPI before return (targetType: ${targetType}, sortBy: ${sortBy}):`, fetchedComments); \n  return fetchedComments; \n};\n\n// --- Helper function for initializing collapse state ---\nconst initializeCollapseStateRecursively = (\n  comments: Comment[],\n  depth: number,\n  state: { [key: number]: boolean }\n) => {\n  comments.forEach(comment => {\n      if (comment.replies && comment.replies.length > 0) {\n          // 修复：默认展开所有评论，无论深度\n          state[comment.id] = false;  // 默认展开\n          // 递归处理子回复\n          initializeCollapseStateRecursively(comment.replies, depth + 1, state);\n      }\n  });\n};\n\nconst CommentSection: React.FC<CommentSectionProps> = ({\n  targetType,\n  targetId,\n  apiBaseUrl,\n  token,\n  currentUser,\n  // --- 新增：解构新的 Props ---\n  isLiked,\n  isCollected,\n  likeCount,\n  collectCount,\n  shareCount,\n  handleLikeToggle,\n  handleCollectToggle,\n  handleShareClick,\n  isSubmittingAction,\n  // --- 结束新增 ---\n}) => {\n  // --- State Management ---\n  const [newComment, setNewComment] = useState('');\n  const [submittingComment, setSubmittingComment] = useState(false);\n  const [replyToCommentId, setReplyToCommentId] = useState<number | null>(null);\n  const [replyContent, setReplyContent] = useState('');\n  const [submittingReply, setSubmittingReply] = useState(false);\n  const [replyTargetUser, setReplyTargetUser] = useState('');\n  const [sortBy, setSortBy] = useState<'latest' | 'popular'>('latest');\n  // 修改：使用useRef存储展开状态，防止刷新时重置\n  const collapsedCommentsRef = useRef<{ [key: number]: boolean }>({});\n  const [collapsedComments, setCollapsedComments] = useState<{ [key: number]: boolean }>({});\n  const [isCommentFocused, setIsCommentFocused] = useState(false);\n  const { token: authToken, user: currentUserFromAuth } = useAuth();\n  const commentInputRef = useRef<HTMLTextAreaElement>(null);\n  const replyInputRef = useRef<HTMLTextAreaElement>(null);\n  const queryClient = useQueryClient();\n  const [refreshAnimationKey, setRefreshAnimationKey] = useState(0);\n  \n  // --- 移到组件内部: 使用useCallback包装初始化函数 ---\n  const initializeCollapseStateRecursively = useCallback((\n    comments: Comment[],\n    depth: number,\n    state: { [key: number]: boolean }\n  ) => {\n    comments.forEach(comment => {\n      if (comment.replies && comment.replies.length > 0) {\n        // 修改：不自动折叠任何评论，保持所有评论默认展开\n        state[comment.id] = false;\n        initializeCollapseStateRecursively(comment.replies, depth + 1, state);\n      }\n    });\n  }, []);\n  \n  // --- TanStack Query for fetching comments ---\n  const commentsQueryKey = ['comments', targetType, targetId, sortBy, currentUser?.id || 'anonymous'];\n\n  const { \n    data: comments = [],\n    isLoading: loadingComments,\n    isError: isCommentError,\n    error: commentError,\n    refetch: refetchComments\n  } = useQuery<Comment[], Error>({\n    queryKey: commentsQueryKey,\n    queryFn: () => fetchCommentsAPI(targetType, targetId, sortBy, authToken),\n    staleTime: 5 * 60 * 1000,\n    gcTime: 10 * 60 * 1000,\n    placeholderData: (previousData) => previousData ?? [],\n    enabled: !!targetId && !!targetType,\n  });\n\n  // --- 修改日志：包含 isLoading 和 isError ---\n  useEffect(() => {\n    console.log(\n        // `[CommentSection DEBUG] State from useQuery (targetType: ${targetType}, targetId: ${targetId}, sortBy: ${sortBy}):`, \n        { isLoading: loadingComments, isError: isCommentError, commentsData: comments } // 同时打印状态和数据\n    );\n    if (isCommentError) {\n        // console.error(\"[CommentSection DEBUG] useQuery reported an error:\", commentError); // 如果出错，打印错误对象\n    }\n  }, [comments, loadingComments, isCommentError, commentError, targetType, targetId, sortBy]); \n  // --- 结束修改 ---\n\n  // --- 修改：点赞、回复等操作后保留评论的展开状态 ---\n  useEffect(() => {\n    if (comments && comments.length > 0) {\n      // 创建新状态对象，但保留已有的展开/折叠状态\n      const updatedState = { ...collapsedCommentsRef.current };\n      \n      // 仅为新的评论ID初始化状态\n      comments.forEach(comment => {\n        if (comment.replies && comment.replies.length > 0) {\n          // 如果评论ID不在当前状态中，则初始化为展开状态\n          if (updatedState[comment.id] === undefined) {\n            updatedState[comment.id] = false; // 默认展开\n          }\n          \n          // 递归处理回复\n          const processReplies = (replies: Comment[]) => {\n            replies.forEach(reply => {\n              if (reply.replies && reply.replies.length > 0) {\n                if (updatedState[reply.id] === undefined) {\n                  updatedState[reply.id] = false; // 默认展开\n                }\n                processReplies(reply.replies);\n              }\n            });\n          };\n          \n          processReplies(comment.replies);\n        }\n      });\n      \n      // 更新状态引用和React状态\n      collapsedCommentsRef.current = updatedState;\n      setCollapsedComments(updatedState);\n    }\n  }, [comments]);\n\n  // --- Helper Functions (Unchanged unless they used old state) ---\n  const countTotalComments = useCallback((commentList: Comment[]): number => {\n    let count = 0;\n    for (const comment of commentList) {\n      count++;\n      if (comment.replies && comment.replies.length > 0) {\n        count += countTotalComments(comment.replies);\n      }\n    }\n    return count;\n  }, []);\n\n  // --- Mutations (Example: Submit Comment) ---\n  const submitCommentMutation = useMutation<\n    Comment,\n    Error,\n    { content: string; mentionLynn?: boolean }\n  >({\n    mutationFn: async ({ content, mentionLynn }) => {\n      // --- 修改：确保使用 original-comments 路径创建文章评论 ---\n      let postUrl = '';\n      if (targetType === 'article') {\n        postUrl = `${API_BASE_URL}/api/original-comments/articles/${targetId}/comments`;\n      } else if (targetType === 'post') {\n        postUrl = `${API_BASE_URL}/api/posts/${targetId}/comments`; // 假设帖子评论创建路径不同\n      } else {\n        throw new Error(`[Submit Comment] Unknown targetType: ${targetType}`);\n      }\n\n      // 构建请求体\n      const requestBody: { content: string; mention_lynn?: boolean } = {\n        content: content.trim(),\n      };\n\n      if (mentionLynn) {\n        requestBody.mention_lynn = true;\n      }\n\n      const response = await axios.post<Comment>(\n        postUrl,\n        requestBody,\n        { headers: { Authorization: `Bearer ${authToken}` } }\n      );\n      return response.data;\n    },\n    onSuccess: (newCommentData) => {\n      queryClient.invalidateQueries({ queryKey: ['comments', targetType, targetId] });\n      setNewComment('');\n      toast.success('评论发表成功！');\n    },\n    onError: (err) => {\n      console.error(\"提交评论失败:\", err);\n      const errorMsg = err.message || '评论提交失败';\n      toast.error(errorMsg);\n    },\n    onSettled: () => {\n      setSubmittingComment(false);\n    }\n  });\n\n  const handleSubmitComment = () => {\n    if (!authToken || !newComment.trim()) {\n      toast.warn(\"评论内容不能为空且需要登录。\");\n      return;\n    }\n    setSubmittingComment(true);\n\n    // 新增：检测 @lynn 提及\n    const mentionLynn = newComment.toLowerCase().includes('@lynn');\n\n    submitCommentMutation.mutate({ content: newComment, mentionLynn });\n  };\n  \n  // --- Submit Reply Mutation (Similar structure) ---\n  const submitReplyMutation = useMutation<\n    Comment,\n    Error,\n    { parentId: number, content: string, mentionLynn?: boolean },\n    ReplyMutationContext\n  >({\n    mutationFn: async ({ parentId, content, mentionLynn }) => {\n      // --- 修改：确保使用 original-comments 路径创建文章回复 ---\n      let replyUrl = '';\n      if (targetType === 'article') {\n        replyUrl = `${API_BASE_URL}/api/original-comments/articles/${targetId}/comments/${parentId}/replies`;\n      } else if (targetType === 'post') {\n        replyUrl = `${API_BASE_URL}/api/posts/${targetId}/comments/${parentId}/replies`; // 假设帖子回复路径不同\n      } else {\n        throw new Error(`[Submit Reply] Unknown targetType: ${targetType}`);\n      }\n      \n      // 增加日志记录请求URL和参数\n      // console.log(`[CommentSection DEBUG] 提交回复请求: ${replyUrl}`, {\n      //   parentId, \n      //   content,\n      //   targetType,\n      //   targetId\n      // });\n      \n      // 构建请求体\n      const requestBody: { content: string; mention_lynn?: boolean } = {\n        content: content.trim(),\n      };\n\n      if (mentionLynn) {\n        requestBody.mention_lynn = true;\n      }\n      \n      const response = await axios.post<Comment>(\n        replyUrl,\n        requestBody,\n        { headers: { Authorization: `Bearer ${authToken}` } }\n      );\n      \n      // 增加日志记录响应结果\n      // console.log(`[CommentSection DEBUG] 提交回复响应:`, response.data);\n      \n      return response.data;\n    },\n    // --- 新增：添加乐观更新逻辑 ---\n    onMutate: async ({ parentId, content }) => {\n      // 取消正在进行的查询以避免它们覆盖我们的乐观更新\n      await queryClient.cancelQueries({ queryKey: commentsQueryKey });\n      \n      // 保存当前状态，以便在出错时恢复\n      const previousComments = queryClient.getQueryData<Comment[]>(commentsQueryKey) || [];\n      \n      // 创建一个临时的乐观回复对象\n      const optimisticReply: Comment = {\n        id: Date.now(), // 临时ID，最终会被后端返回的实际ID替换\n        content: content,\n        created_at: new Date().toISOString(),\n        user_id: currentUser?.id || null,\n        parent_id: parentId,\n        user: currentUser, // 当前用户信息\n        replies: [],\n        likes_count: 0,\n        is_liked_by_current_user: false,\n        _isOptimistic: true, // 标记为乐观更新的临时对象\n        is_ai_generated: false,\n      };\n      \n      // 更新缓存数据，添加新回复到父评论\n      queryClient.setQueryData<Comment[]>(commentsQueryKey, (oldComments = []) => {\n        // 深拷贝旧评论列表\n        const newComments = JSON.parse(JSON.stringify(oldComments));\n        \n        // 定义一个递归函数来找到父评论并添加回复\n        const addReplyToParent = (comments: Comment[]): Comment[] => {\n          return comments.map(comment => {\n            if (comment.id === parentId) {\n              // 找到父评论，添加回复\n              return {\n                ...comment,\n                replies: [...(comment.replies || []), optimisticReply]\n              };\n            }\n            \n            // 如果有嵌套回复，也在其中查找\n            if (comment.replies && comment.replies.length > 0) {\n              return {\n                ...comment,\n                replies: addReplyToParent(comment.replies)\n              };\n            }\n            \n            return comment;\n          });\n        };\n        \n        return addReplyToParent(newComments);\n      });\n      \n      // console.log(\"[CommentSection] 已添加乐观回复\");\n      \n      // 返回上下文对象，用于出错时恢复\n      return { previousComments };\n    },\n    // --- 结束新增 ---\n    onSuccess: (newReplyData, variables) => {\n      // --- 修改：更精确的缓存更新 ---\n      // console.log(\"[CommentSection] 回复成功，更新缓存:\", newReplyData);\n      \n      // 更新缓存，替换乐观回复为实际回复\n      queryClient.setQueryData<Comment[]>(commentsQueryKey, (oldComments = []) => {\n        if (!oldComments.length) {\n          // 如果没有缓存的评论，重新获取\n          queryClient.invalidateQueries({ queryKey: commentsQueryKey });\n          return oldComments;\n        }\n        \n        // 深拷贝旧评论列表\n        const newComments = JSON.parse(JSON.stringify(oldComments));\n        \n        // 更新临时回复为实际回复\n        const updateOptimisticReply = (comments: Comment[]): Comment[] => {\n          return comments.map(comment => {\n            if (comment.id === variables.parentId) {\n              return {\n                ...comment,\n                replies: comment.replies.map(reply => \n                  // 如果是之前创建的乐观回复，替换为真实数据\n                  (reply._isOptimistic) ? newReplyData : reply\n                )\n              };\n            }\n            \n            if (comment.replies && comment.replies.length > 0) {\n              return {\n                ...comment,\n                replies: updateOptimisticReply(comment.replies)\n              };\n            }\n            \n            return comment;\n          });\n        };\n        \n        return updateOptimisticReply(newComments);\n      });\n      // --- 结束修改 ---\n      \n      setReplyContent('');\n      setReplyToCommentId(null);\n      toast.success('回复成功！');\n    },\n    onError: (err, variables, context) => {\n      console.error(\"提交回复失败:\", err);\n      toast.error(err.message || '回复提交失败');\n      \n      // --- 新增：错误恢复 ---\n      // 恢复到之前的状态\n      if (context?.previousComments) {\n        queryClient.setQueryData(commentsQueryKey, context.previousComments);\n      }\n      // --- 结束新增 ---\n    },\n    onSettled: () => {\n      setSubmittingReply(false);\n    }\n  });\n\n  const handleSubmitReply = (parentId: number) => {\n    if (!authToken || !replyContent.trim()) {\n      toast.warn(\"回复内容不能为空且需要登录。\");\n      return;\n    }\n    setSubmittingReply(true);\n\n    // 新增：检测 @lynn 提及\n    const mentionLynnForReply = replyContent.toLowerCase().includes('@lynn');\n\n    submitReplyMutation.mutate({ parentId, content: replyContent, mentionLynn: mentionLynnForReply });\n  };\n\n  // --- Delete Comment Mutation ---\n  const deleteCommentMutation = useMutation<\n    void,\n    Error,\n    { commentId: number }\n  >({\n    mutationFn: async ({ commentId }) => {\n      // --- 修改：确保使用 original-comments 路径删除文章评论 ---\n      let deleteUrl = '';\n      if (targetType === 'article') {\n        // 根据 original_comments.py 中的路由定义，删除需要 article_id\n        deleteUrl = `${API_BASE_URL}/api/original-comments/articles/${targetId}/comments/${commentId}`;\n      } else if (targetType === 'post') {\n        deleteUrl = `${API_BASE_URL}/api/posts/${targetId}/comments/${commentId}`; // 假设帖子删除路径不同\n      } else {\n         throw new Error(`[Delete Comment] Unknown targetType: ${targetType}`);\n      }\n      await axios.delete(deleteUrl, { headers: { Authorization: `Bearer ${authToken}` } });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['comments', targetType, targetId] });\n      toast.success('评论已删除');\n    },\n    onError: (err) => {\n      console.error(\"删除评论失败:\", err);\n      toast.error(err.message || '删除评论失败');\n    },\n  });\n\n  const handleDeleteCommentOrReply = (commentId: number) => {\n    if (!authToken) {\n      toast.error(\"请先登录。\");\n      return;\n    }\n    if (!window.confirm('确定要删除这条评论吗？其下的回复将保留，但此评论内容会消失。')) {\n      return;\n    }\n    deleteCommentMutation.mutate({ commentId });\n  };\n\n  // --- Like/Unlike Mutations (Can be combined or separate) ---\n  const toggleLikeMutation = useMutation<\n    { likes_count: number; is_liked_by_current_user: boolean },\n    Error,\n    { commentId: number; isLiked: boolean }\n  >({\n    mutationFn: async ({ commentId, isLiked }) => {\n      let url;\n      // 根据评论目标类型 (targetType prop) 构造不同的点赞 URL\n      if (targetType === 'post') {\n        // 帖子评论使用 /api/posts/post_comments/.../like\n        url = `${API_BASE_URL}/api/posts/post_comments/${commentId}/like`;\n      } else if (targetType === 'article') {\n        // 文章评论使用 /api/original-comments/comments/.../like\n        // original_comments.py 中的相应路由默认 target_type 为 'article'\n        url = `${API_BASE_URL}/api/original-comments/comments/${commentId}/like`;\n      } else {\n        console.error(`[CommentSection ERROR] Unsupported targetType for like: ${targetType}`);\n        // 保留一个回退，尽管理想情况下应该为所有支持的类型明确处理或报错\n        url = `${API_BASE_URL}/api/comments/${commentId}/like?target_type=${targetType}`;\n      }\n      \n      // console.log(`[CommentSection DEBUG] Toggle like URL: ${url}`);\n\n      let response;\n      if (isLiked) {\n        response = await axios.delete(url, { headers: { Authorization: `Bearer ${authToken}` } });\n      } else {\n        response = await axios.post(url, {}, { headers: { Authorization: `Bearer ${authToken}` } });\n      }\n      // --- 状态码检查保持不变 ---\n      if (!(response.status === 200 || response.status === 201 || response.status === 204)) {\n         throw new Error(response.data?.message || 'Like/Unlike API Error');\n      }\n      \n      // 处理响应数据中的字段名可能不一致的问题\n      const responseData = response.data || {};\n      // 修改：优先读取 likes_count，兼容旧的 like_count\n      const result = {\n        likes_count: responseData.likes_count !== undefined ? responseData.likes_count : (responseData.like_count || 0),\n        is_liked_by_current_user: responseData.is_liked_by_current_user !== undefined \n          ? responseData.is_liked_by_current_user \n          : responseData.is_liked \n      };\n      \n      return result;\n    },\n    onSuccess: (data, variables) => {\n      queryClient.setQueryData(commentsQueryKey, (oldData: Comment[] | undefined = []) => {\n        const updateRecursively = (list: Comment[]): Comment[] => list.map(c => {\n          if (c.id === variables.commentId) {\n            return { \n              ...c, \n              // 修改：更新缓存中的 likes_count\n              likes_count: data.likes_count, \n              is_liked_by_current_user: data.is_liked_by_current_user \n            };\n          }\n          if (c.replies && c.replies.length > 0) {\n            return { ...c, replies: updateRecursively(c.replies) };\n          }\n          return c;\n        });\n        return updateRecursively(oldData);\n      });\n    },\n    onError: (err, variables) => {\n      console.error(\"Like/Unlike失败:\", err);\n      toast.error(`操作失败: ${err.message}`);\n    }\n  });\n\n  const handleLike = (commentId: number) => {\n    if (!authToken) { toast.warn(\"请先登录\"); return; }\n    toggleLikeMutation.mutate({ commentId, isLiked: false });\n  };\n\n  const handleUnlike = (commentId: number) => {\n    if (!authToken) { toast.warn(\"请先登录\"); return; }\n    toggleLikeMutation.mutate({ commentId, isLiked: true });\n  };\n\n  // --- Other functions (handleReplyClick, handleCancelReply, toggleReplies, handleSortChange, etc.) remain largely the same ---\n  const handleReplyClick = (commentId: number, targetUsername: string) => {\n    if (replyToCommentId === commentId) {\n      setReplyToCommentId(null);\n      setReplyTargetUser('');\n      setReplyContent('');\n    } else {\n      if (replyToCommentId !== null) {\n        setReplyToCommentId(null);\n        setReplyTargetUser('');\n        setReplyContent('');\n        setTimeout(() => {\n      setReplyToCommentId(commentId);\n      setReplyTargetUser(targetUsername);\n      setReplyContent('');\n          setTimeout(() => { replyInputRef.current?.focus(); }, 10);\n        }, 10);\n      } else {\n        setReplyToCommentId(commentId);\n        setReplyTargetUser(targetUsername);\n        setReplyContent('');\n        setTimeout(() => { replyInputRef.current?.focus(); }, 10);\n      }\n    }\n  };\n  \n  const handleCancelReply = () => {\n    setReplyToCommentId(null);\n    setReplyTargetUser('');\n    setReplyContent('');\n  };\n  \n  // --- 修改：切换评论折叠状态的函数，确保也更新ref ---\n  const toggleReplies = (commentId: number, e?: React.MouseEvent) => {\n    e?.stopPropagation();\n    \n    const newState = {\n      ...collapsedComments,\n      [commentId]: !collapsedComments[commentId]\n    };\n    \n    // 同时更新引用和状态\n    collapsedCommentsRef.current = newState;\n    setCollapsedComments(newState);\n  };\n\n  const handleSortChange = (e: React.MouseEvent, newSortBy: 'latest' | 'popular') => {\n    e.preventDefault();\n    e.stopPropagation();\n    \n    if (sortBy !== newSortBy) {\n      const scrollPos = commentsContainerRef.current?.scrollTop || 0;\n      \n      setSortBy(prevSortBy => {\n        console.log(`切换排序：${prevSortBy} -> ${newSortBy}`);\n        return newSortBy;\n      });\n      \n      // 手动触发数据重新获取\n      refetchComments();\n\n      requestAnimationFrame(() => {\n        if (commentsContainerRef.current) {\n          commentsContainerRef.current.scrollTop = scrollPos;\n        }\n      });\n    }\n  };\n\n  const handleCommentChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    setNewComment(e.target.value);\n  };\n\n  const handleReplyChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    setReplyContent(e.target.value);\n  };\n\n  const handleCommentFocus = () => setIsCommentFocused(true);\n  const handleCommentBlur = () => {\n    if (!newComment.trim()) {\n      setIsCommentFocused(false);\n        }\n  };\n\n  // Restore commentsContainerRef definition\n  const commentsContainerRef = useRef<HTMLDivElement>(null);\n\n  // --- 新增：刷新按钮点击处理函数 ---\n  const handleRefreshComments = useCallback(() => {\n    if (!loadingComments) { // Only trigger animation if not already loading\n        setRefreshAnimationKey(prevKey => prevKey + 1);\n    }\n    if (refetchComments) { // Check if refetchComments is defined\n        refetchComments();\n        toast.info(\"正在刷新评论...\");\n    } else {\n        console.error(\"refetchComments function is not available.\");\n        toast.error(\"刷新功能暂时无法使用。\");\n    }\n  }, [loadingComments, refetchComments]);\n  // --- 结束新增 ---\n\n  // --- Restore renderComment function definition ---\n  const renderComment = (comment: Comment, depth = 0) => {\n    const isRootComment = depth === 0;\n    const displayName = comment.is_ai_generated \n                        ? (comment.user?.nickname || 'Lynn')\n                        : (comment.user?.nickname || comment.user?.email?.split('@')[0] || '匿名用户');\n    const isReplying = replyToCommentId === comment.id;\n    const canDelete = currentUser && comment.user && currentUser.id === comment.user.id && !comment.is_deleted && !comment.is_ai_generated;\n    const isLikedByCurrentUser = comment.is_liked_by_current_user;\n    const currentLikeCount = comment.likes_count;\n    const isDeleted = comment.is_deleted === true;\n    const shouldHideReplies = collapsedComments[comment.id] === true;\n    const hasReplies = comment.replies && comment.replies.length > 0;\n    const repliesCount = hasReplies ? countTotalComments(comment.replies) : 0;\n\n    return (\n      <div key={comment.id} className={`comment-item ${depth > 0 ? 'ml-4 md:ml-6' : ''} py-3 relative`}>\n         {depth > 0 && (\n            <div className=\"absolute left-0 top-0 bottom-0 w-px bg-white/50 -ml-3 md:-ml-4\"\n              style={{ top: '1.5rem', bottom: '0.5rem' }}></div>\n         )}\n         <div className=\"flex items-start space-x-2 mb-1 user-info\">\n            {/* 修复：确保折叠/展开按钮对所有有回复的评论都显示，不仅限于嵌套回复 */}\n            {hasReplies && (\n                <button\n                    onClick={(e) => toggleReplies(comment.id, e)}\n                    className=\"text-gray-400 hover:text-white py-0 px-0.5 focus:outline-none font-mono text-xs flex items-center justify-center flex-shrink-0 mr-1\"\n                    style={{ \n                      marginLeft: depth > 0 ? '-2rem' : '0', \n                      width: '2rem', \n                      textAlign: 'center',\n                      minWidth: '2rem'\n                    }}\n                    aria-label={shouldHideReplies ? '展开回复' : '收起回复'}>\n                    {shouldHideReplies ? `[+${repliesCount}]` : '[-]'}\n                </button>\n            )}\n            <UserAvatar userId={comment.user?.id ?? undefined} \n                        username={displayName} \n                        avatar={comment.user?.avatar} \n                        size=\"sm\" \n                        showName={false}\n            />\n            <div className=\"flex-grow flex items-baseline justify-between ml-2\">\n                <span className={`font-medium text-sm ${comment.is_ai_generated ? 'text-purple-400' : (comment.user ? 'text-gray-100' : 'text-gray-400')}`}>\n                  {displayName}\n                </span>\n            <span className=\"text-xs text-gray-400 pt-1 ml-auto\">\n                  {formatDistanceToNow(new Date(comment.created_at), { addSuffix: true, locale: zhCN })}\n                </span>\n         </div>\n         </div>\n         <div className={`${depth > 0 ? 'pl-8' : 'pl-0'}`}> \n            <p className={`text-sm mt-1 whitespace-pre-wrap break-words ${isDeleted ? 'text-blue-400 italic' : 'text-gray-300'}`}>\n              {comment.content}\n            </p>\n            <div className=\"mt-2 flex items-center space-x-4\">\n                {!isDeleted && (\n                    <>\n                        <button onClick={() => handleReplyClick(comment.id, displayName)}\n                  className={`text-xs ${isReplying ? 'text-blue-400' : 'text-gray-400 hover:text-blue-400'} flex items-center`}\n                            disabled={!authToken} title={!authToken ? \"请先登录\" : (isReplying ? \"取消回复\" : \"回复\")}>\n                            <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-3.5 w-3.5\" viewBox=\"0 0 20 20\" fill=\"currentColor\"><path fillRule=\"evenodd\" d=\"M7.707 3.293a1 1 0 010 1.414L5.414 7H11a7 7 0 017 7v2a1 1 0 11-2 0v-2a5 5 0 00-5-5H5.414l2.293 2.293a1 1 0 11-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z\" clipRule=\"evenodd\" /></svg>\n                </button>\n                         <button onClick={() => authToken ? (isLikedByCurrentUser ? handleUnlike(comment.id) : handleLike(comment.id)) : toast.warn('请先登录后点赞')}\n                            className={`text-xs flex items-center transition-colors duration-200 ${isLikedByCurrentUser ? 'text-pink-500 hover:text-pink-400' : 'text-gray-400 hover:text-pink-400'}`}\n                            disabled={!authToken || toggleLikeMutation.isPending} title={!authToken ? \"请先登录\" : (isLikedByCurrentUser ? \"取消点赞\" : \"点赞\")}>\n                            {isLikedByCurrentUser ? (\n                                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-3.5 w-3.5\" viewBox=\"0 0 20 20\" fill=\"currentColor\"><path fillRule=\"evenodd\" d=\"M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z\" clipRule=\"evenodd\" /></svg>\n                    ) : (\n                                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-3.5 w-3.5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" strokeWidth=\"2\"><path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z\" /></svg>\n                    )}\n                            {/* 修改：为点赞数添加固定宽度布局 */}\n                            <span className=\"tabular-nums\" style={{ display: 'inline-block', minWidth: '1rem', textAlign: 'left', marginLeft: '0.125rem' }}>\n                              {currentLikeCount > 0 ? currentLikeCount : ''}\n                            </span>\n                 </button>\n                {canDelete && (\n                          <button onClick={() => handleDeleteCommentOrReply(comment.id)}\n                              className=\"text-xs text-gray-400 hover:text-red-400 flex items-center\" title=\"删除评论\">\n                              <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-3.5 w-3.5\" viewBox=\"0 0 20 20\" fill=\"currentColor\"><path fillRule=\"evenodd\" d=\"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z\" clipRule=\"evenodd\" /></svg>\n                  </button>\n                        )}\n                    </>\n                )}\n              </div>\n              {replyToCommentId === comment.id && (\n                <div className=\"relative w-full mt-3\">\n                   <textarea ref={replyInputRef} value={replyContent} onChange={handleReplyChange}\n                    placeholder={`回复 ${replyTargetUser}...`} rows={2}\n                    className=\"w-full p-3 pr-10 pb-3 bg-gray-800/90 rounded-md text-sm text-white placeholder-gray-400 resize-none h-16 shadow-inner border-0 outline-none\"\n                    autoFocus />\n                  <div className=\"absolute bottom-2 right-2 flex items-center space-x-2\">\n                     <button onClick={() => handleSubmitReply(comment.id)}\n                       disabled={submittingReply || !replyContent.trim()} title=\"回复\"\n                       className={`text-white hover:text-blue-300 disabled:text-gray-500 disabled:cursor-not-allowed transition-colors duration-200 p-1 rounded hover:bg-gray-700/50 ${submittingReply ? 'animate-pulse' : ''}`}>\n                         <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5 transform rotate-180\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" strokeWidth=\"2\"><path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M3 10h10a8 8 0 018 8v2M3 10l4-4m-4 4l4 4\" /></svg>\n                     </button>\n                   </div>\n                     </div>\n                   )}\n                </div>\n         {hasReplies && !shouldHideReplies && (\n             <div className=\"replies-container relative mt-2 space-y-3 ml-8\">\n             {comment.replies.map(reply => renderComment(reply, depth + 1))}\n           </div>\n         )}\n      </div>\n    );\n  };\n\n  // --- 主渲染 ---\n  return (\n    <div className=\"mt-10 pt-6 border-t border-gray-700/50\" ref={commentsContainerRef}>\n       {/* --- 修改：评论区头部，包含评论总数、排序和操作按钮 --- */}\n      <div className=\"flex justify-between items-center mb-6\">\n         {/* --- 修改：将评论图标和计数添加到按钮组 --- */}\n         <div className=\"flex items-center space-x-3\">\n            {/* 评论图标和计数 */}\n            <div className=\"flex items-center text-gray-400 text-sm\">\n                {/* @ts-ignore */}\n                <MessageSquare size={16} className=\"mr-1\" />\n                <span className=\"tabular-nums\">({countTotalComments(comments)})</span>\n            </div>\n            {/* 点赞按钮 */}\n            <button\n              onClick={handleLikeToggle}\n              className={`p-1.5 rounded-md text-sm font-medium flex items-center gap-1 transition-colors duration-300 \n                ${isLiked ? 'text-pink-400 hover:text-pink-300 active:text-pink-500' : 'text-gray-400 hover:text-gray-200 active:text-gray-300'} \n                ${!token && 'opacity-50 cursor-not-allowed'}`}\n              disabled={!token}\n              title={!token ? \"请先登录\" : (isLiked ? '取消点赞' : '点赞')}\n            >\n              <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-4 w-4\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n                <path fillRule=\"evenodd\" d=\"M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z\" clipRule=\"evenodd\" />\n              </svg>\n              <span className=\"tabular-nums\">({likeCount})</span>\n            </button>\n            {/* 收藏按钮 */}\n            <button\n              onClick={handleCollectToggle}\n              className={`p-1.5 rounded-md text-sm font-medium flex items-center gap-1 transition-colors duration-300 \n                ${isCollected ? 'text-yellow-400 hover:text-yellow-300 active:text-yellow-500' : 'text-gray-400 hover:text-gray-200 active:text-gray-300'} \n                ${!token && 'opacity-50 cursor-not-allowed'}`}\n              disabled={!token}\n              title={!token ? \"请先登录\" : (isCollected ? '取消收藏' : '收藏')}\n            >\n              <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-4 w-4\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n                <path d=\"M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-3.5L5 18V4z\" />\n              </svg>\n              <span className=\"tabular-nums\">({collectCount})</span>\n            </button>\n            {/* 分享按钮 */}\n          <button \n              onClick={handleShareClick}\n              className={`p-1.5 rounded-md text-sm font-medium flex items-center gap-1 transition-colors duration-300 \n                text-gray-400 hover:text-gray-200 active:text-gray-300 \n                ${!token && 'opacity-50 cursor-not-allowed'}`}\n              disabled={!token}\n              title={!token ? \"请先登录\" : \"分享\"}\n            >\n              <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-4 w-4\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" strokeWidth={2}>\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z\" />\n            </svg>\n              {shareCount > 0 && <span className=\"tabular-nums\">({shareCount})</span>}\n          </button>\n         </div>\n         {/* --- 结束新增操作按钮 --- */}\n\n         {/* --- 修改：将排序按钮移回左侧 --- */}\n         <div className=\"flex items-center space-x-2\">\n                <button\n              onClick={(e) => handleSortChange(e, 'latest')}\n              className={`px-4 py-1.5 rounded-full border transition-colors text-xs font-medium ${ \n                sortBy === 'latest' \n                  ? 'bg-gray-700/50 border-gray-500 text-gray-300'\n                  : 'bg-transparent border-gray-600 text-gray-500 hover:border-gray-400 hover:text-gray-300'\n              }`}\n                >\n                  最新\n                </button>\n                <button\n              onClick={(e) => handleSortChange(e, 'popular')}\n              className={`px-4 py-1.5 rounded-full border transition-colors text-xs font-medium ${ \n                sortBy === 'popular' \n                  ? 'bg-gray-700/50 border-gray-500 text-gray-300'\n                  : 'bg-transparent border-gray-600 text-gray-500 hover:border-gray-400 hover:text-gray-300'\n              }`}\n                >\n                  热门\n                </button>\n              </div>\n         {/* --- 结束排序按钮修改 --- */}\n      </div>\n      {/* --- 结束修改 --- */}\n\n      {/* 评论输入框 */}\n      {token && currentUser && (\n        <div className=\"mb-8 flex items-center space-x-2\">\n          <div className=\"relative flex-grow\">\n            <textarea\n              ref={commentInputRef}\n              value={newComment}\n              onChange={handleCommentChange}\n              onFocus={handleCommentFocus}\n              onBlur={handleCommentBlur}\n              className={`w-full px-4 py-3 pr-12 bg-gray-800/80 backdrop-blur-sm rounded-xl\n                focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-white text-sm \n                resize-none placeholder-gray-400 shadow-inner\n                transition-all duration-300 ease-in-out\n                ${isCommentFocused || newComment.trim() ? 'h-24' : 'h-12'}`}\n              rows={isCommentFocused || newComment.trim() ? 3 : 1}\n              placeholder={isCommentFocused ? \"\" : \"发表评论...\"}\n              disabled={submittingComment}\n              onKeyDown={(e) => { \n                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {\n                    handleSubmitComment();\n                }\n              }}\n            />\n            <div className={`absolute bottom-3 right-3 flex items-center space-x-2\n                transition-opacity duration-300 ease-in-out\n                ${isCommentFocused || newComment.trim() ? 'opacity-100' : 'opacity-0'}`}>\n              <button\n                onClick={handleSubmitComment}\n                disabled={submittingComment || !newComment.trim() || submitCommentMutation.isPending}\n                  className={`p-2 text-blue-400 hover:text-blue-300 rounded-md transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500 ${submittingComment ? 'animate-pulse' : ''}`}\n                  title=\"提交评论 (Cmd/Ctrl+Enter)\"\n              >\n                   {submitCommentMutation.isPending ? (\n                      <svg className=\"animate-spin h-5 w-5\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\">\n                          <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                          <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                      </svg>\n                  ) : (\n                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5 transform rotate-180\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" strokeWidth=\"2\">\n                         <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M3 10h10a8 8 0 018 8v2M3 10l4-4m-4 4l4 4\" />\n                 </svg>\n                  )}\n              </button>\n            </div>\n          </div>\n\n          {/* 外部刷新按钮 (始终可见) */}\n          <button\n              onClick={handleRefreshComments}\n              disabled={loadingComments}\n              className=\"p-1.5 text-gray-400 hover:text-blue-300 active:text-blue-500 transition-colors duration-150 rounded-full hover:bg-gray-700/30 active:bg-gray-600/30 focus:outline-none flex-shrink-0\"\n              title=\"刷新评论\"\n          >\n              {loadingComments ? (\n                  <FaSpinner className=\"animate-spin h-4 w-4\" />\n              ) : (\n                  <motion.div\n                      key={`outer-input-refresh-${refreshAnimationKey}`}\n                      initial={{ rotate: 0 }}\n                      animate={{ rotate: 360 }}\n                      transition={{ duration: 0.4, ease: \"linear\" }}\n                      style={{ display: 'flex' }}\n                  >\n                      <FaSyncAlt className=\"h-4 w-4 block\" />\n                  </motion.div>\n              )}\n          </button>\n        </div>\n      )}\n\n      {/* Comment List */}\n      {loadingComments && comments.length === 0 ? (\n         <div className=\"text-center text-gray-500 py-8\">加载评论中...</div>\n      ) : isCommentError ? (\n         <div className=\"text-center text-red-400 py-8\">{commentError?.message || '加载评论失败'}</div>\n      ) : comments.length > 0 ? (\n        <div className=\"space-y-4 pb-8\">\n          {comments.map((comment) => {\n            return renderComment(comment);\n          })}\n        </div>\n      ) : (\n        <div className=\"text-center text-gray-500 py-8\">\n          <p>暂无评论，来发表第一条评论吧</p>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default CommentSection; "],"names":["MessageSquare","createLucideIcon","d","key","_ref","targetType","targetId","apiBaseUrl","token","currentUser","isLiked","isCollected","likeCount","collectCount","shareCount","handleLikeToggle","handleCollectToggle","handleShareClick","isSubmittingAction","newComment","setNewComment","useState","submittingComment","setSubmittingComment","replyToCommentId","setReplyToCommentId","replyContent","setReplyContent","submittingReply","setSubmittingReply","replyTargetUser","setReplyTargetUser","sortBy","setSortBy","collapsedCommentsRef","useRef","collapsedComments","setCollapsedComments","isCommentFocused","setIsCommentFocused","authToken","user","currentUserFromAuth","useAuth","commentInputRef","replyInputRef","queryClient","useQueryClient","refreshAnimationKey","setRefreshAnimationKey","initializeCollapseStateRecursively","useCallback","comments","depth","state","forEach","comment","replies","length","id","commentsQueryKey","data","isLoading","loadingComments","isError","isCommentError","error","commentError","refetch","refetchComments","useQuery","queryKey","queryFn","async","apiUrlBase","API_BASE_URL","apiUrlWithSort","fetchedComments","_response$data","axios","get","headers","Authorization","fetchCommentsAPI","staleTime","gcTime","placeholderData","previousData","enabled","useEffect","console","log","commentsData","updatedState","current","undefined","processReplies","reply","countTotalComments","commentList","count","submitCommentMutation","useMutation","mutationFn","content","mentionLynn","_ref2","postUrl","Error","requestBody","trim","mention_lynn","post","onSuccess","newCommentData","invalidateQueries","toast","success","onError","err","errorMsg","message","onSettled","handleSubmitComment","warn","toLowerCase","includes","mutate","submitReplyMutation","parentId","_ref3","replyUrl","onMutate","_ref4","cancelQueries","previousComments","getQueryData","optimisticReply","Date","now","created_at","toISOString","user_id","parent_id","likes_count","is_liked_by_current_user","_isOptimistic","is_ai_generated","setQueryData","oldComments","arguments","newComments","JSON","parse","stringify","addReplyToParent","map","newReplyData","variables","updateOptimisticReply","context","deleteCommentMutation","commentId","_ref5","deleteUrl","delete","toggleLikeMutation","url","response","_ref6","_response$data2","status","responseData","like_count","is_liked","updateRecursively","list","c","handleSortChange","e","newSortBy","preventDefault","stopPropagation","_commentsContainerRef","scrollPos","commentsContainerRef","scrollTop","prevSortBy","requestAnimationFrame","handleReplyChange","target","value","handleRefreshComments","prevKey","info","renderComment","_comment$user","_comment$user2","_comment$user3","_comment$user3$email","_comment$user$id","_comment$user4","_comment$user5","displayName","nickname","email","split","isReplying","canDelete","is_deleted","isLikedByCurrentUser","currentLikeCount","isDeleted","shouldHideReplies","hasReplies","repliesCount","_jsxs","className","children","_jsx","style","top","bottom","onClick","toggleReplies","newState","marginLeft","width","textAlign","minWidth","UserAvatar","userId","username","avatar","size","showName","formatDistanceToNow","addSuffix","locale","zhCN","_Fragment","handleReplyClick","targetUsername","setTimeout","_replyInputRef$curren","focus","_replyInputRef$curren2","disabled","title","xmlns","viewBox","fill","fillRule","clipRule","handleLike","isPending","stroke","strokeWidth","strokeLinecap","strokeLinejoin","display","handleDeleteCommentOrReply","window","confirm","ref","onChange","placeholder","rows","autoFocus","mentionLynnForReply","handleSubmitReply","onFocus","handleCommentFocus","onBlur","handleCommentBlur","onKeyDown","ctrlKey","metaKey","cx","cy","r","FaSpinner","motion","div","initial","rotate","animate","transition","duration","ease","FaSyncAlt"],"sourceRoot":""}